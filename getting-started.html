<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="author" title="About these documents" href="about.html" /><link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Under the Hood" href="under-the-hood.html" /><link rel="prev" title="What is Archimedes?" href="about.html" />

    <link rel="shortcut icon" href="_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>Getting Started - Archimedes documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=c2950814" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #D35400;
  --color-brand-content: #C0392B;
  --color-admonition-background: rgba(211, 84, 0, 0.1);
  --color-background-primary: #F5F5F5;
  --color-background-secondary: #EEEEEE;
  --color-foreground-primary: #2A2A2A;
  --color-foreground-secondary: #5D4037;
  --color-link: #C0392B;
  --color-link-hover: #D35400;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #F1C40F;
  --color-brand-content: #D35400;
  --color-admonition-background: rgba(241, 196, 15, 0.1);
  --color-background-primary: #2A2A2A;
  --color-background-secondary: #1A1A1A;
  --color-foreground-primary: #F5F5F5;
  --color-foreground-secondary: #DDDDDD;
  --color-link: #D35400;
  --color-link-hover: #F1C40F;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #F1C40F;
  --color-brand-content: #D35400;
  --color-admonition-background: rgba(241, 196, 15, 0.1);
  --color-background-primary: #2A2A2A;
  --color-background-secondary: #1A1A1A;
  --color-foreground-primary: #F5F5F5;
  --color-foreground-secondary: #DDDDDD;
  --color-link: #D35400;
  --color-link-hover: #F1C40F;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Archimedes  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
    <div class="sidebar-brand-container">
      <img class="sidebar-logo" src="_static/logo.png" alt="Logo"/>
      <div class="sidebar-brand-text">Archimedes</div>
    </div>
  </a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">What is Archimedes?</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Getting Started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="under-the-hood.html">Under the Hood</a></li>
<li class="toctree-l1"><a class="reference internal" href="pytrees.html">Working with PyTrees</a></li>
<li class="toctree-l1"><a class="reference internal" href="generated/notebooks/control-flow.html">Structured Control Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="generated/notebooks/modular-design.html">Hierarchical Design Patterns</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="notebooks/multirotor/multirotor00.html">Multirotor Dynamics</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Multirotor Dynamics</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="notebooks/multirotor/multirotor01.html">Part 1: Fundamentals of multirotor dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/multirotor/multirotor02.html">Part 2: Implementation in Archimedes</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/notebooks/multirotor/multirotor03.html">Part 3: Running the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/notebooks/multirotor/multirotor04.html">Part 4: Model analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/notebooks/multirotor/multirotor05.html">Part 5: Revisiting the rotor model (optional)</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/multirotor/multirotor06.html">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="notebooks/deployment/deployment00.html">Deploying to Hardware</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Deploying to Hardware</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="generated/notebooks/deployment/deployment01.html">Generating C code</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/notebooks/deployment/deployment02.html">Generating driver code</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/notebooks/deployment/deployment03.html">Platform-specific deployment templates</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="gotchas.html">üî™ Quirks and Gotchas</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="reference/index.html">üìö API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of üìö API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.codegen.html">archimedes.codegen</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.array.html">archimedes.array</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.sym.html">archimedes.sym</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.sym_like.html">archimedes.sym_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.zeros.html">archimedes.zeros</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.ones.html">archimedes.ones</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.zeros_like.html">archimedes.zeros_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.ones_like.html">archimedes.ones_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.eye.html">archimedes.eye</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.scan.html">archimedes.scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.switch.html">archimedes.switch</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.vmap.html">archimedes.vmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.compile.html">archimedes.compile</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.callback.html">archimedes.callback</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.grad.html">archimedes.grad</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.jac.html">archimedes.jac</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.hess.html">archimedes.hess</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.jvp.html">archimedes.jvp</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.vjp.html">archimedes.vjp</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.interpolant.html">archimedes.interpolant</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.integrator.html">archimedes.integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.odeint.html">archimedes.odeint</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.nlp_solver.html">archimedes.nlp_solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.minimize.html">archimedes.minimize</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.implicit.html">archimedes.implicit</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.root.html">archimedes.root</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.qpsol.html">archimedes.qpsol</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="generated/api/archimedes.tree.html">archimedes.tree</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of archimedes.tree</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.all.html">archimedes.tree.all</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.flatten.html">archimedes.tree.flatten</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.leaves.html">archimedes.tree.leaves</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.map.html">archimedes.tree.map</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.ravel.html">archimedes.tree.ravel</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.reduce.html">archimedes.tree.reduce</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.register_dataclass.html">archimedes.tree.register_dataclass</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.register_pytree_node.html">archimedes.tree.register_pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.structure.html">archimedes.tree.structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.unflatten.html">archimedes.tree.unflatten</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="generated/api/archimedes.tree.struct.html">archimedes.tree.struct</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of archimedes.tree.struct</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.dataclass_transform.html">archimedes.tree.struct.dataclass_transform</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.field.html">archimedes.tree.struct.field</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.fields.html">archimedes.tree.struct.fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.is_pytree_node.html">archimedes.tree.struct.is_pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.pytree_node.html">archimedes.tree.struct.pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.register_dataclass.html">archimedes.tree.struct.register_dataclass</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.replace.html">archimedes.tree.struct.replace</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.Any.html">archimedes.tree.struct.Any</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.Callable.html">archimedes.tree.struct.Callable</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.InitVar.html">archimedes.tree.struct.InitVar</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.TypeVar.html">archimedes.tree.struct.TypeVar</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Development Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="licensing-model.html">Licensing model</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/getting-started.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="getting-started">
<h1>Getting Started<a class="headerlink" href="#getting-started" title="Link to this heading">¬∂</a></h1>
<p>This page will walk through some basic functionality and examples to get you started with some of the patterns and conventions of Archimedes.
Before working through this page, you may want to make sure you have a working <a class="reference internal" href="quickstart.html"><span class="doc std std-doc">installation</span></a> and read through <a class="reference internal" href="about.html"><span class="doc std std-doc">‚ÄúWhat is Archimedes?‚Äù</span></a> to understand the basic conceptual framework and terminology.</p>
<section id="compiling-functions">
<span id="id1"></span><h2>Compiling functions<a class="headerlink" href="#compiling-functions" title="Link to this heading">¬∂</a></h2>
<p>The most basic operation in Archimedes is creating a ‚Äúcompiled‚Äù function, which is done as follows:</p>
<ol class="arabic simple">
<li><p>Write out your computation in NumPy</p></li>
<li><p>Encapsulate it into a function</p></li>
<li><p>Decorate the function with <code class="docutils literal notranslate"><span class="pre">&#64;compile</span></code></p></li>
</ol>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">arc</span>

<span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">rotate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span>
    <span class="p">],</span> <span class="n">like</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">R</span> <span class="o">@</span> <span class="n">x</span>

<span class="n">rotate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>That‚Äôs it! Archimedes automatically converted your NumPy-based function into an efficient C++ implementation that can be evaluated symbolically or numerically, or converted into other useful forms via function transformations.</p>
</section>
<section id="computing-derivatives">
<span id="id2"></span><h2>Computing derivatives<a class="headerlink" href="#computing-derivatives" title="Link to this heading">¬∂</a></h2>
<p>Many applications across scientific computing rely on derivatives: optimization, implicit ODE solvers, Newton solvers, linearization, and various forms of sensitivity analysis.</p>
<p>Archimedes makes it easy to compute these derivatives efficiently and accurately by making use of CasADi‚Äôs powerful <em>automatic differentiation</em> system:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simple example: derivative of a scalar function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">df</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)))</span>

<span class="c1"># Jacobian with respect to a particular argument</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dynamics</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># prey growth rate</span>
        <span class="n">c</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># predator growth rate</span>
    <span class="p">],</span> <span class="n">like</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

<span class="n">J</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">jac</span><span class="p">(</span><span class="n">dynamics</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">J</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]))</span>

<span class="c1"># Hessian of an objective function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">obj</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>

<span class="n">H</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">hess</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">x0</span><span class="p">))</span>
</pre></div>
</div>
<p>Archimedes also supports more specialized derivative functionality like Jacobian-vector products (<code class="docutils literal notranslate"><span class="pre">jvp</span></code>) and vector-Jacobian products (<code class="docutils literal notranslate"><span class="pre">vjp</span></code>).
The automatic differentiation feature also composes with functionality like ODE solving, so for example you can compute the sensitivity of an ODE solution or embed a derivative in the dynamics function of an ODE.</p>
<p>Finally, the CasADi autodiff backend supports <em>sparse</em> automatic differentiation for the common case that the derivatives with respect to many variables are zero.
For example, in an optimization problem with 1000 variables, the Hessian is a <span class="math notranslate nohighlight">\(1000 \times 1000\)</span> matrix where in practice many entries are zero.
Working with sparse autodiff can have huge performance implications in large-scale constrained optimization.
This is a major benefit of Archimedes/CasADi compared to deep learning frameworks that typically work with dense gradient vectors for unconstrained first-order optimization.</p>
</section>
<section id="ode-solving">
<span id="id3"></span><h2>ODE solving<a class="headerlink" href="#ode-solving" title="Link to this heading">¬∂</a></h2>
<p>Let‚Äôs solve a simple differential equation (the Lotka-Volterra predator-prey model):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">arc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Define and compile the system dynamics</span>
<span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dynamics</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># prey growth rate</span>
        <span class="n">c</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># predator growth rate</span>
    <span class="p">],</span> <span class="n">like</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># Initial conditions and timespan</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">t_span</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">t_span</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># Solve the ODE system</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">odeint</span><span class="p">(</span><span class="n">dynamics</span><span class="p">,</span> <span class="n">t_span</span><span class="o">=</span><span class="n">t_span</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">t_eval</span><span class="o">=</span><span class="n">ts</span><span class="p">)</span>

<span class="c1"># Plot the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">xs</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Prey&#39;</span><span class="p">,</span> <span class="s1">&#39;Predator&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">odeint</span></code> function is designed to closely mimic <code class="docutils literal notranslate"><span class="pre">scipy.integrate.solve_ivp</span></code> for a familiar interface.
By default Archimedes uses the powerful <a class="reference external" href="https://computing.llnl.gov/projects/sundials/cvodes">CVODES</a> solver that can handle stiff or non-stiff ODE systems.<br />
When needed, Archimedes will use automatic differentiation to efficiently compute the Jacobian of the dynamics.</p>
<p>The one thing you should note here is that when we create the array in the <code class="docutils literal notranslate"><span class="pre">dynamics</span></code> function we need to tell NumPy to create an array <code class="docutils literal notranslate"><span class="pre">like=x</span></code> in order to dispatch to the Archimedes <code class="docutils literal notranslate"><span class="pre">array</span></code> function.
Otherwise NumPy will attempt to create its own <code class="docutils literal notranslate"><span class="pre">ndarray</span></code> full of symbolic objects that it doesn‚Äôt know how to manipulate, and will ultimately throw an error.
Alternatively, you can use functions like <code class="docutils literal notranslate"><span class="pre">vstack</span></code>, which will work with either symbolic or numeric arguments.</p>
<p>If the same ODE solve will be applied repeatedly (for instance varying initial conditions or parameters), it can be convenient to use a <em>function transformation</em> to create an integrator function instead of calling <code class="docutils literal notranslate"><span class="pre">odeint</span></code> to do a one-time solve:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solver</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">integrator</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;cvodes&quot;</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">t_span</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="optimization">
<span id="id4"></span><h2>Optimization<a class="headerlink" href="#optimization" title="Link to this heading">¬∂</a></h2>
<p>Archimedes also provides an interface designed after <code class="docutils literal notranslate"><span class="pre">scipy.optimize.minimize</span></code> that supports nonlinear constrained optimization problems.
This uses sparse automatic differentiation to construct all required gradients, Jacobians, and Hessians and calls out to powerful large-scale solvers like IPOPT,</p>
<p>For example, here we solve the classic Rosenbrock problem:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>

<span class="n">x_opt</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
</pre></div>
</div>
<p>and a <a class="reference external" href="https://en.wikipedia.org/wiki/Test_functions_for_optimization#Test_functions_for_constrained_optimization">constrained variation</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span><span class="w"> </span><span class="nf">g</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">g1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">g2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">],</span> <span class="n">like</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

<span class="n">x_opt</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">constr</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">constr_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
<p>As with the <code class="docutils literal notranslate"><span class="pre">integrator</span></code>, we can also define an <code class="docutils literal notranslate"><span class="pre">nlp_solver</span></code> function for efficient repeated optimization solves (in model-predictive control applications, for instance):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solver</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">nlp_solver</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">constr</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
<span class="n">x_opt</span> <span class="o">=</span> <span class="n">solver</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># x0, lower_bound, upper_bound</span>
</pre></div>
</div>
</section>
<section id="root-finding-and-implicit-functions">
<span id="implicit-functions"></span><h2>Root-finding and implicit functions<a class="headerlink" href="#root-finding-and-implicit-functions" title="Link to this heading">¬∂</a></h2>
<p>A root-finding problem is defined as the solution to a system of equations <span class="math notranslate nohighlight">\(f(x, p) = 0\)</span>, where <span class="math notranslate nohighlight">\(p\)</span> is a parameter vector and <span class="math notranslate nohighlight">\(x\)</span> is a vector of optimization variables.
Archimedes provides root-finding functionality with an interface similar to <code class="docutils literal notranslate"><span class="pre">scipy.optimize.root</span></code>, but which uses automatic differentiation to compute the Jacobian and can itself be differentiated.</p>
<p>Here‚Äôs an example borrowed from the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.root.html">SciPy documentation</a>, without the need for manually constructing a Jacobian:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">],</span> <span class="n">like</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># array([0.8411639, 0.1588361])</span>
</pre></div>
</div>
<p>The more general form <span class="math notranslate nohighlight">\(f(x, p) = 0\)</span> can also be thought of as defining <span class="math notranslate nohighlight">\(x\)</span> as an implicit function of <span class="math notranslate nohighlight">\(p\)</span>.
That is, <span class="math notranslate nohighlight">\(x = F(p)\)</span>, where it might be difficult or impossible to explicitly write out how to compute <span class="math notranslate nohighlight">\(F(p)\)</span>.
In Archimedes, we can directly construct a function that is equivalent to <code class="docutils literal notranslate"><span class="pre">F</span></code> using the <code class="docutils literal notranslate"><span class="pre">implicit</span></code> <em>function transformation</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">F</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">implicit</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># Transform f(x, p) = 0 to x = F(p)</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Initial guess</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="pytrees">
<span id="id5"></span><h2>PyTrees<a class="headerlink" href="#pytrees" title="Link to this heading">¬∂</a></h2>
<p>Many scientific computing functions assume that data is arranged into flat vectors.
This includes ODE integrators, optimizers, root-finders, and other solvers.
It is usually easier to mathematically represent the state of a system or a set of parameters as a vector.</p>
<p>However, this is not necessarily the most natural way to implement a physical model, which may have distinct components or hierarchical structure that makes transforming to/from a flat vector tedious and error-prone.</p>
<p>Archimedes addresses this with the concept of a PyTree; a data structure consisting of nested containers that can be flattened, unflattened, or manipulated directly as a tree.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]),</span> <span class="s2">&quot;vel&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])}</span>
<span class="n">flat</span><span class="p">,</span> <span class="n">unravel</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">flat</span><span class="p">)</span>  <span class="c1"># [0. 1. 2. 3. 4. 5.]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">unravel</span><span class="p">(</span><span class="n">flat</span><span class="p">))</span> <span class="c1"># {&#39;pos&#39;: array([0., 1., 2.]), &#39;vel&#39;: array([3., 4., 5.])}</span>
</pre></div>
</div>
<p>A similar approach can work for containers nested to arbitrary depth, i.e. tuples of dictionaries of lists.</p>
<section id="structured-data-classes">
<h3>Structured Data Classes<a class="headerlink" href="#structured-data-classes" title="Link to this heading">¬∂</a></h3>
<p>If you want to go beyond built-in Python containers, Archimedes provides a <code class="docutils literal notranslate"><span class="pre">struct</span></code> module that combines Python‚Äôs <code class="docutils literal notranslate"><span class="pre">dataclass</span></code> with automatic PyTree registration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">archimedes.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">struct</span>

<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">VehicleState</span><span class="p">:</span>
    <span class="n">position</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># [x, y, z]</span>
    <span class="n">velocity</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># [vx, vy, vz]</span>
    <span class="n">attitude</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># quaternion [qx, qy, qz, qw]</span>
    <span class="n">angular_velocity</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># [wx, wy, wz]</span>

<span class="c1"># Create an instance</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">VehicleState</span><span class="p">(</span>
    <span class="n">position</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">velocity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">attitude</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">angular_velocity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Flatten to a single vector</span>
<span class="n">flat_state</span><span class="p">,</span> <span class="n">unravel</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="c1"># Pass to/from compiled functions</span>
<span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">euler_dynamics</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">control</span><span class="p">):</span>
    <span class="c1"># Access structured fields naturally</span>
    <span class="n">new_position</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">velocity</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">state</span><span class="o">.</span><span class="n">position</span>
    <span class="c1"># ...</span>
    <span class="k">return</span> <span class="n">VehicleState</span><span class="p">(</span>
        <span class="n">position</span><span class="o">=</span><span class="n">new_position</span><span class="p">,</span>
        <span class="c1"># ...</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>In addition, these custom PyTree nodes are regular classes, so you can define methods as usual.
For example, you can create a callable class with some parameters using the special <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PredatorPrey</span><span class="p">:</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">b</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">c</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">d</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">],</span> <span class="n">like</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">PredatorPrey</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="n">t0</span><span class="p">,</span> <span class="n">tf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">x0</span><span class="p">))</span>  <span class="c1"># Call like a function</span>
</pre></div>
</div>
<p>For more information, see <a class="reference internal" href="pytrees.html"><span class="std std-doc">‚ÄúWorking with PyTrees‚Äù</span></a>.</p>
</section>
</section>
<section id="interpolation">
<span id="id6"></span><h2>Interpolation<a class="headerlink" href="#interpolation" title="Link to this heading">¬∂</a></h2>
<p>Basic one-dimensional interpolation can be done with the standard NumPy interface:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="nd">@compile</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;MX&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="mf">2.5</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">fp</span><span class="p">)))</span>
</pre></div>
</div>
<p>N-dimensional lookup tables can be constructed as <code class="docutils literal notranslate"><span class="pre">interpolant</span></code> functions, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">RectBivariateSpline</span>

<span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">ygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">X</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">+</span> <span class="mi">1</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">/</span> <span class="n">R</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">interpolant</span><span class="p">(</span>
    <span class="p">[</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">],</span>
    <span class="n">Z</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">),</span>
    <span class="n">arg_names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span>
    <span class="n">ret_name</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;f&quot;</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;bspline&quot;</span><span class="p">,</span>  <span class="c1"># one of (&quot;linear&quot;, &quot;bspline&quot;)</span>
<span class="p">)</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span>
<span class="n">interp</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">interp</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>
</pre></div>
</div>
<p>The Archimedes interpolant matches the SciPy one, but can be embedded in other functions, differentiated through, etc.</p>
</section>
<section id="control-flow">
<span id="id7"></span><h2>Control flow<a class="headerlink" href="#control-flow" title="Link to this heading">¬∂</a></h2>
<p>One limitation of the symbolic-numeric computations in Archimedes is that it is not compatible with standard Python control flow constructs like <code class="docutils literal notranslate"><span class="pre">if</span></code>/<code class="docutils literal notranslate"><span class="pre">else</span></code> and <code class="docutils literal notranslate"><span class="pre">while</span></code> loops.
This is because Python does not have a dispatch mechanism for control flow similar to NumPy‚Äôs for array functions.
In other words, Python doesn‚Äôt know how to handle symbolic conditional execution.
When applied to symbolic arrays, these will either throw errors or result in unpredictable behavior.</p>
<p>To implement a conditional like <code class="docutils literal notranslate"><span class="pre">if</span></code>/<code class="docutils literal notranslate"><span class="pre">else</span></code>, a simple workaround is to use <code class="docutils literal notranslate"><span class="pre">np.where</span></code>, which can use NumPy‚Äôs dispatch mechanism to handle symbolic arguments:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># # Will not work when x is symbolic</span>
    <span class="c1"># if x &gt; 0.5:</span>
    <span class="c1">#     return np.cos(x)</span>
    <span class="c1"># else:</span>
    <span class="c1">#     return np.sin(x)</span>

    <span class="c1"># Works with symbolic or numeric x</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>To implement <code class="docutils literal notranslate"><span class="pre">for</span></code> loops, if the length of the loop is known ahead of time it is possible to write a plain Python loop.
However, it is recommended that you put the contents of the loop in a separately compiled function to help keep the size of the computational graph small by minimizing ‚Äúcall sites‚Äù:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">g0</span> <span class="o">=</span> <span class="mf">9.8</span>

<span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">euler_step</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">g0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">like</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dt</span>

<span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">static_argnames</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;tf&quot;</span><span class="p">,))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">solve_pendulum</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">tf</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tf</span> <span class="o">//</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)))</span>
    <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">euler_step</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>When repeatedly applying a function across an axis of inputs, a more efficient approach is to create a ‚Äúvectorized map‚Äù of the function using <code class="docutils literal notranslate"><span class="pre">vmap</span></code>, which provides similar functionality to <a class="reference external" href="https://docs.jax.dev/en/latest/_autosummary/jax.vmap.html"><code class="docutils literal notranslate"><span class="pre">jax.vmap</span></code></a> or <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.vectorize.html"><code class="docutils literal notranslate"><span class="pre">numpy.vectorize</span></code></a>. This allows you to write a function as if it acted on a single example of input and then map across a set of inputs.</p>
<p>For example, here we write a function that takes the dot product of two vectors, and then apply it across a ‚Äúbatch‚Äù of vectors:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="c1"># Vectorize to compute multiple dot products at once</span>
<span class="n">batched_dot</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span>

<span class="c1"># Input: batch of vectors (3 vectors of length 2)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]])</span>

<span class="c1"># Output: batch of scalars (3 dot products)</span>
<span class="n">batched_dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>The axes to map the function along can be specified by the <code class="docutils literal notranslate"><span class="pre">in_axes</span></code> keyword argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">batched_dot</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">batched_dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>  <span class="c1"># Map along the second axis of y.T</span>
</pre></div>
</div>
<p>For more complex loops or improved compilation times, Archimedes also provides a <code class="docutils literal notranslate"><span class="pre">scan</span></code> function similar to <a class="reference external" href="https://docs.jax.dev/en/latest/_autosummary/jax.lax.scan.html"><code class="docutils literal notranslate"><span class="pre">jax.lax.scan</span></code></a>, which creates a single call site for the loop body function and does something similar to the following pure Python code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">scan</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">init_carry</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">xs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
    <span class="n">carry</span> <span class="o">=</span> <span class="n">init_carry</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
        <span class="n">carry</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">carry</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
</pre></div>
</div>
<p>This loop maintains a state, and also returns an output for each element of the input.
Here‚Äôs a simple example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="c1"># carry is the accumulated state, x is the current element</span>
    <span class="n">new_carry</span> <span class="o">=</span> <span class="n">carry</span> <span class="o">+</span> <span class="n">x</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">new_carry</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># some computation with the updated state</span>
    <span class="k">return</span> <span class="n">new_carry</span><span class="p">,</span> <span class="n">y</span>

<span class="n">init_carry</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="n">final_carry</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">init_carry</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final state:&quot;</span><span class="p">,</span> <span class="n">final_carry</span><span class="p">)</span>  <span class="c1"># 15 (sum of all elements)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Outputs:&quot;</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>  <span class="c1"># [ 2  6 12 20 30]</span>
</pre></div>
</div>
<p>This function also supports tree-structured arguments for <code class="docutils literal notranslate"><span class="pre">carry</span></code>, but the return type of <code class="docutils literal notranslate"><span class="pre">func</span></code> must match the initial carry type.
There is a learning curve associated with structured control flow functions like <code class="docutils literal notranslate"><span class="pre">scan</span></code>, but it is a powerful and flexible function for constructing symbolically traceable control flow like bounded while loops and map-accumulate operations.</p>
<p>For more details, see the <a class="reference internal" href="generated/notebooks/control-flow.html"><span class="doc std std-doc">full documentation page on control flow</span></a></p>
</section>
<section id="functional-programming">
<span id="id8"></span><h2>Functional programming<a class="headerlink" href="#functional-programming" title="Link to this heading">¬∂</a></h2>
<p>There is a common thread between all of these examples that is worth keeping in mind; because of its design around function transformations, Archimedes maintains a primarily ‚Äúfunctional‚Äù programming paradigm.</p>
<p>Specifically, Archimedes works by symbolically tracing your functions to create a computational graph, and then applying transformations to that graph or embedding it in more complex functions.
As a result, you should structure all code to be ‚Äúfunctionally pure‚Äù, meaning that the outputs are a direct function of the inputs, and the function does not attempt to modify inputs or any global variables.
Doing so can lead to unpredictable behavior or errors.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pure function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Impure: modifies a global variable</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">i</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="n">x</span>
</pre></div>
</div>
<p>One subtle exception is that it is allowed for functions to modify symbolic inputs.  This is because the actual input is replaced by a new symbolic variable before tracing, so the modification of the input is simply traced as part of the computational graph and the original numeric value is not modified.
That is, the resulting function will be ‚Äúpure‚Äù even if the original Python code wasn‚Äôt.</p>
<p>This can be a convenient shorthand, but should be used with caution due to the divergence in behavior between Archimedes and standard Python.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>

<span class="c1"># The priginal Python function mutates the input in place</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># [2. 0. 0.]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># [1. 0. 0.]</span>

<span class="c1"># The compile is forced to be pure</span>
<span class="n">f_sym</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">f_sym</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># [2. 0. 0.]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># [0. 0. 0.]</span>
</pre></div>
</div>
<p>In general, learning to work with pure functions can be an adjustment.
Fortunately, domains like math and physics are built on pure functions, and impure functions usually arise as an implementation detail (e.g. allocating work arrays in legacy Fortran code).
If you keep your code as close to the underlying mathematical model as possible, it will tend to be functionally pure.</p>
</section>
<section id="custom-callbacks">
<span id="id9"></span><h2>Custom callbacks<a class="headerlink" href="#custom-callbacks" title="Link to this heading">¬∂</a></h2>
<!--
TODO: Write this once the functionality is implemented.
-->
</section>
<section id="scipy-cookbook">
<span id="id10"></span><h2>SciPy Cookbook<a class="headerlink" href="#scipy-cookbook" title="Link to this heading">¬∂</a></h2>
<p>Archimedes supports some common functionality like <a class="reference internal" href="#ode-solving">ODE solving</a>, <a class="reference internal" href="#optimization">constrained nonlinear optimization</a>, and <a class="reference internal" href="#implicit-functions">nonlinear root-finding</a>, but in some cases you may wish to use particular solvers or functionality from larger libraries like SciPy.</p>
<p>In this case you have three basic options:</p>
<ol class="arabic simple">
<li><p>Use the SciPy function as an ‚Äúoffline‚Äù step to generate static arrays.</p></li>
<li><p>Pass Archimedes functions (and possibly derivatives) to SciPy functions</p></li>
<li><p>Write a <a class="reference internal" href="#custom-callbacks">callback function</a> to embed the external function in the computational graph</p></li>
</ol>
<p>As an example of the first case, you can construct an IIR filter outside of an Archimedes function and then use the filter coefficients as NumPy arrays.  This doesn‚Äôt require symbolically tracing the IIR filter construction.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Construct an IIR filter and write a `compile` stepping it forward</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">signal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">arc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>


<span class="c1"># 1. Design a Butterworth lowpass filter (offline step with SciPy)</span>
<span class="n">fs</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Sample frequency in Hz</span>
<span class="n">cutoff</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Cutoff frequency in Hz</span>
<span class="n">order</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># Filter order</span>
<span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">/</span> <span class="p">(</span><span class="n">fs</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;low&#39;</span><span class="p">)</span>

<span class="c1"># 2. Create a compiled function that implements the IIR filter</span>
<span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">iir_filter_step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">b_coef</span><span class="p">,</span> <span class="n">a_coef</span><span class="p">):</span>
    <span class="c1"># Calculate output: y = b[0]*x + state[0]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">b_coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Update state using direct form II transposed structure</span>
    <span class="n">state_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">state_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_coef</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">a_coef</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span>
    
    <span class="c1"># Handle the last state element</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_coef</span><span class="p">):</span>
            <span class="n">state_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_coef</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">a_coef</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">a_coef</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span>
    
    <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">state_new</span>

<span class="c1"># Function to filter an entire signal using our IIR filter</span>
<span class="k">def</span><span class="w"> </span><span class="nf">filter_signal</span><span class="p">(</span><span class="n">signal_data</span><span class="p">,</span> <span class="n">b_coef</span><span class="p">,</span> <span class="n">a_coef</span><span class="p">):</span>
    <span class="c1"># Initialize state array (size depends on filter order)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a_coef</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_coef</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">signal_data</span><span class="p">)</span>
    
    <span class="c1"># Apply the filter step by step</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signal_data</span><span class="p">)):</span>
        <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">state</span> <span class="o">=</span> <span class="n">iir_filter_step</span><span class="p">(</span><span class="n">signal_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">state</span><span class="p">,</span> <span class="n">b_coef</span><span class="p">,</span> <span class="n">a_coef</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">output</span>

<span class="c1"># Create a test signal with mixed frequencies</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>
<span class="n">signal_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>

<span class="c1"># Apply our filter</span>
<span class="n">filtered</span> <span class="o">=</span> <span class="n">filter_signal</span><span class="p">(</span><span class="n">signal_data</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

<span class="c1"># Compare with SciPy&#39;s lfilter (should be identical)</span>
<span class="n">filtered_scipy</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">signal_data</span><span class="p">)</span>

<span class="c1"># Plot results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">signal_data</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original Signal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">filtered</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Archimedes Filtered&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">filtered_scipy</span><span class="p">,</span> <span class="s1">&#39;g--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SciPy Filtered&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;IIR Filter Comparison&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>For applications like data processing, it is clearly preferable to just use the SciPy implementation.
However, combining the ‚Äúoffline‚Äù filter design with a symbolic filtering function allows you to use the filter as part of a control algorithm within a larger computational graph, and also opens up the possibility of automated C code generation for embedded applications.</p>
<p>In the second case, you may want to use a SciPy optimizer like BFGS for an unconstrained optimization problem.
In this case you can still take advantage of the efficient C++ computations and automatic differentiation in Archimedes, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">arc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimize</span>

<span class="c1"># Solve Rosenbrock problem using BFGS</span>
<span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>  <span class="c1"># Initial guess</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
    <span class="n">func</span><span class="p">,</span> 
    <span class="n">x0</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">,</span>
    <span class="n">jac</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">func</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note that there is some overhead in translating between the NumPy arrays and CasADi‚Äôs internal array structures, so this is not guaranteed to be faster than vanilla NumPy; the performance will be dictated by the relative complexity of an individual function evaluation compared to the number of function evaluations.
For instance, in the Rosenbrock example above the fastest solution is actually plain NumPy with finite differencing, even though this uses about 3x as many function evaluations!
This will often not be the case for more complex practical applications.</p>
<!-- TODO: Write an example callback when this is implemented -->
<p>All of these strategies will also work for libraries beyond SciPy.
Integration with other libraries like Matplotlib is largely straightforward, since Archimedes works with NumPy arrays and visualizations can be created ‚Äúoffline‚Äù as a postprocessing step.</p>
</section>
<section id="basic-troubleshooting">
<span id="id11"></span><h2>Basic Troubleshooting<a class="headerlink" href="#basic-troubleshooting" title="Link to this heading">¬∂</a></h2>
<p>For more details, see the <a class="reference internal" href="gotchas.html"><span class="std std-doc">Quirks and Gotchas</span></a> page, but here are some common early pitfalls:</p>
<ul class="simple">
<li><p><strong>Error when creating arrays</strong>: Remember to use <code class="docutils literal notranslate"><span class="pre">like=x</span></code> or functions like <code class="docutils literal notranslate"><span class="pre">vstack</span></code> with symbolic arguments</p></li>
<li><p><strong>Unexpected results with conditional logic</strong>: Use <code class="docutils literal notranslate"><span class="pre">np.where</span></code> instead of Python <code class="docutils literal notranslate"><span class="pre">if/else</span></code> with symbolic arguments</p></li>
<li><p><strong>Poor performance</strong>: Ensure you‚Äôre reusing solver functions rather than recreating them for repeated calls</p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="under-the-hood.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Under the Hood</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="about.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">What is Archimedes?</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Pine Tree Labs, LLC
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Getting Started</a><ul>
<li><a class="reference internal" href="#compiling-functions">Compiling functions</a></li>
<li><a class="reference internal" href="#computing-derivatives">Computing derivatives</a></li>
<li><a class="reference internal" href="#ode-solving">ODE solving</a></li>
<li><a class="reference internal" href="#optimization">Optimization</a></li>
<li><a class="reference internal" href="#root-finding-and-implicit-functions">Root-finding and implicit functions</a></li>
<li><a class="reference internal" href="#pytrees">PyTrees</a><ul>
<li><a class="reference internal" href="#structured-data-classes">Structured Data Classes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#interpolation">Interpolation</a></li>
<li><a class="reference internal" href="#control-flow">Control flow</a></li>
<li><a class="reference internal" href="#functional-programming">Functional programming</a></li>
<li><a class="reference internal" href="#custom-callbacks">Custom callbacks</a></li>
<li><a class="reference internal" href="#scipy-cookbook">SciPy Cookbook</a></li>
<li><a class="reference internal" href="#basic-troubleshooting">Basic Troubleshooting</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>