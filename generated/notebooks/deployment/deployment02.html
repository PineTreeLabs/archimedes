<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="author" title="About these documents" href="../../../about.html" /><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" /><link rel="next" title="Platform-specific deployment templates" href="deployment03.html" /><link rel="prev" title="Generating C code" href="deployment01.html" />

    <link rel="shortcut icon" href="../../../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>Generating driver code - Archimedes documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=c2950814" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #D35400;
  --color-brand-content: #C0392B;
  --color-admonition-background: rgba(211, 84, 0, 0.1);
  --color-background-primary: #F5F5F5;
  --color-background-secondary: #EEEEEE;
  --color-foreground-primary: #2A2A2A;
  --color-foreground-secondary: #5D4037;
  --color-link: #C0392B;
  --color-link-hover: #D35400;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #F1C40F;
  --color-brand-content: #D35400;
  --color-admonition-background: rgba(241, 196, 15, 0.1);
  --color-background-primary: #2A2A2A;
  --color-background-secondary: #1A1A1A;
  --color-foreground-primary: #F5F5F5;
  --color-foreground-secondary: #DDDDDD;
  --color-link: #D35400;
  --color-link-hover: #F1C40F;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #F1C40F;
  --color-brand-content: #D35400;
  --color-admonition-background: rgba(241, 196, 15, 0.1);
  --color-background-primary: #2A2A2A;
  --color-background-secondary: #1A1A1A;
  --color-foreground-primary: #F5F5F5;
  --color-foreground-secondary: #DDDDDD;
  --color-link: #D35400;
  --color-link-hover: #F1C40F;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">Archimedes  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
    <div class="sidebar-brand-container">
      <img class="sidebar-logo" src="../../../_static/logo.png" alt="Logo"/>
      <div class="sidebar-brand-text">Archimedes</div>
    </div>
  </a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">What is Archimedes?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started.html">Getting Started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../under-the-hood.html">Under the Hood</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytrees.html">Working with PyTrees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../control-flow.html">Structured Control Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modular-design.html">Hierarchical Design Patterns</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../notebooks/multirotor/multirotor00.html">Multirotor Dynamics</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Multirotor Dynamics</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/multirotor/multirotor01.html">Part 1: Fundamentals of multirotor dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/multirotor/multirotor02.html">Part 2: Implementation in Archimedes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multirotor/multirotor03.html">Part 3: Running the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multirotor/multirotor04.html">Part 4: Model analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multirotor/multirotor05.html">Part 5: Revisiting the rotor model (optional)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/multirotor/multirotor06.html">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../../notebooks/deployment/deployment00.html">Deploying to Hardware</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Deploying to Hardware</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="deployment01.html">Generating C code</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Generating driver code</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment03.html">Platform-specific deployment templates</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../gotchas.html">🔪 Quirks and Gotchas</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../reference/index.html">📚 API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of 📚 API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.codegen.html">archimedes.codegen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.array.html">archimedes.array</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.sym.html">archimedes.sym</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.sym_like.html">archimedes.sym_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.zeros.html">archimedes.zeros</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.ones.html">archimedes.ones</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.zeros_like.html">archimedes.zeros_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.ones_like.html">archimedes.ones_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.eye.html">archimedes.eye</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.scan.html">archimedes.scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.switch.html">archimedes.switch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.vmap.html">archimedes.vmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.compile.html">archimedes.compile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.callback.html">archimedes.callback</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.grad.html">archimedes.grad</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.jac.html">archimedes.jac</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.hess.html">archimedes.hess</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.jvp.html">archimedes.jvp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.vjp.html">archimedes.vjp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.interpolant.html">archimedes.interpolant</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.integrator.html">archimedes.integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.odeint.html">archimedes.odeint</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.nlp_solver.html">archimedes.nlp_solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.minimize.html">archimedes.minimize</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.implicit.html">archimedes.implicit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.root.html">archimedes.root</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/archimedes.qpsol.html">archimedes.qpsol</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/archimedes.tree.html">archimedes.tree</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of archimedes.tree</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.all.html">archimedes.tree.all</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.flatten.html">archimedes.tree.flatten</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.leaves.html">archimedes.tree.leaves</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.map.html">archimedes.tree.map</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.ravel.html">archimedes.tree.ravel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.reduce.html">archimedes.tree.reduce</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.register_dataclass.html">archimedes.tree.register_dataclass</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.register_pytree_node.html">archimedes.tree.register_pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.structure.html">archimedes.tree.structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.unflatten.html">archimedes.tree.unflatten</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/archimedes.tree.struct.html">archimedes.tree.struct</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of archimedes.tree.struct</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.struct.dataclass_transform.html">archimedes.tree.struct.dataclass_transform</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.struct.field.html">archimedes.tree.struct.field</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.struct.fields.html">archimedes.tree.struct.fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.struct.is_pytree_node.html">archimedes.tree.struct.is_pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.struct.pytree_node.html">archimedes.tree.struct.pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.struct.register_dataclass.html">archimedes.tree.struct.register_dataclass</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.struct.replace.html">archimedes.tree.struct.replace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.struct.Any.html">archimedes.tree.struct.Any</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.struct.Callable.html">archimedes.tree.struct.Callable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.struct.InitVar.html">archimedes.tree.struct.InitVar</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/archimedes.tree.struct.TypeVar.html">archimedes.tree.struct.TypeVar</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../roadmap.html">Development Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licensing-model.html">Licensing model</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../../../_sources/generated/notebooks/deployment/deployment02.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ruff: noqa: N802, N803, N806, N815, N816</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">signal</span>

<span class="c1"># Simple utilities for displaying generated code in the notebook</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">cleanup</span><span class="p">,</span> <span class="n">display_text</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">arc</span>

<span class="n">THEME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ARCHIMEDES_THEME&quot;</span><span class="p">,</span> <span class="s2">&quot;dark&quot;</span><span class="p">)</span>
<span class="n">arc</span><span class="o">.</span><span class="n">theme</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">THEME</span><span class="p">)</span>
</pre></div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="generating-driver-code">
<h1>Generating driver code<a class="headerlink" href="#generating-driver-code" title="Link to this heading">¶</a></h1>
<p>In the previous part of this tutorial, we learned how to automatically translate Python code to highly efficient C implementations.
However, the C code generated by CasADi uses a generic interface that requires that all arrays be initialized externally.
If we want to call the generated function from our own C code or use it in an embedded setting, this creates overhead of having to manually determine and adjust array sizes, names, initializations, etc.</p>
<p>In embedded systems, memory management is critical. The core algorithm code generated in Part 1 is extremely efficient, but it expects:</p>
<ol class="arabic simple">
<li><p>Pre-allocated memory buffers for all inputs and outputs</p></li>
<li><p>Properly configured pointers to these buffers</p></li>
<li><p>Initialization of working memory needed by the algorithm</p></li>
</ol>
<p>Manually handling these details would be tedious and error-prone - especially when algorithms change during development.</p>
<p>Archimedes handles this with a templated “driver code” system, where you can generate code that takes care of this boilerplate for you.  On this page we will go through some of the details of this system, beginning with generating a simple plain C-code driver.</p>
<p>First, let’s recall the basic IIR filter implementation we were working with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Optionally give descriptive names for return values (these don&#39;t need</span>
<span class="c1"># to match the variable names)</span>
<span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">return_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;u_hist&quot;</span><span class="p">,</span> <span class="s2">&quot;y_hist&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">iir_filter</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">u_prev</span><span class="p">,</span> <span class="n">y_prev</span><span class="p">):</span>
    <span class="c1"># Update input history</span>
    <span class="n">u_prev</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">u_prev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">u_prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>

    <span class="c1"># Compute output using the direct II transposed structure</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">u_prev</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">y_prev</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Update output history</span>
    <span class="n">y_prev</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">y_prev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y_prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">return</span> <span class="n">u_prev</span><span class="p">,</span> <span class="n">y_prev</span>
</pre></div>
</div>
<p>The only modification from last time is that we will now use the <code class="docutils literal notranslate"><span class="pre">driver</span></code> argument to <a class="reference internal" href="../../api/archimedes.codegen.html#archimedes.codegen" title="archimedes.codegen"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">codegen</span></code></span></a>.  To begin with we will just give the specification “c”, which will generate a basic <code class="docutils literal notranslate"><span class="pre">main.c</span></code> file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cleanup</span><span class="p">()</span>  <span class="c1"># Clean up any previous generated code</span>

<span class="c1"># Design a simple IIR filter with SciPy</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># Sampling time [seconds]</span>
<span class="n">Wn</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Cutoff frequency [Hz]</span>
<span class="n">order</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">Wn</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="n">analog</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>

<span class="c1"># Create &quot;template&quot; arguments for type inference</span>
<span class="n">u</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">u_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
<span class="n">y_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">u_prev</span><span class="p">,</span> <span class="n">y_prev</span><span class="p">)</span>

<span class="n">arc</span><span class="o">.</span><span class="n">codegen</span><span class="p">(</span><span class="n">iir_filter</span><span class="p">,</span> <span class="s2">&quot;iir_filter.c&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;main.c&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">main_c</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">display_text</span><span class="p">(</span><span class="n">main_c</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// gcc main.c iir_filter.c</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;iir_filter.h&quot;</span>

<span class="c1">// PROTECTED-REGION-START: imports</span>
<span class="c1">// ... User-defined imports and includes</span>
<span class="c1">// PROTECTED-REGION-END</span>

<span class="c1">// Allocate memory for inputs and outputs</span>
<span class="kt">double</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.004824343357716228</span><span class="p">,</span><span class="w"> </span><span class="mf">0.019297373430864913</span><span class="p">,</span><span class="w"> </span><span class="mf">0.02894606014629737</span><span class="p">,</span><span class="w"> </span><span class="mf">0.019297373430864913</span><span class="p">,</span><span class="w"> </span><span class="mf">0.004824343357716228</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-2.369513007182038</span><span class="p">,</span><span class="w"> </span><span class="mf">2.313988414415881</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.054665405878568</span><span class="p">,</span><span class="w"> </span><span class="mf">0.18737949236818502</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">u_prev</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">y_prev</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>

<span class="kt">double</span><span class="w"> </span><span class="n">u_hist</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">y_hist</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="c1">// Prepare pointers to inputs, outputs, and work arrays</span>
<span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">[</span><span class="n">iir_filter_SZ_ARG</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="p">[</span><span class="n">iir_filter_SZ_RES</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iw</span><span class="p">[</span><span class="n">iir_filter_SZ_IW</span><span class="p">];</span>
<span class="kt">double</span><span class="w"> </span><span class="n">w</span><span class="p">[</span><span class="n">iir_filter_SZ_W</span><span class="p">];</span>

<span class="c1">// PROTECTED-REGION-START: allocation</span>
<span class="c1">// ... User-defined memory allocation and function declaration</span>
<span class="c1">// PROTECTED-REGION-END</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Set up input and output pointers</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_prev</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_prev</span><span class="p">;</span>

<span class="w">    </span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_hist</span><span class="p">;</span>
<span class="w">    </span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_hist</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// PROTECTED-REGION-START: main</span>
<span class="w">    </span><span class="c1">// ... User-defined program body</span>
<span class="w">    </span><span class="n">iir_filter</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">iw</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// PROTECTED-REGION-END</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you are familiar with C, this code will be largely self-explanatory.
It takes care of all array and pointer initialization, specifically initializing all arrays to the values of the “template arguments” we passed to <code class="docutils literal notranslate"><span class="pre">codegen</span></code>.
For example, if we want to choose a different order and cutoff filter, we can do so easily:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cleanup</span><span class="p">()</span>  <span class="c1"># Cleanup any previous runs</span>

<span class="c1"># Design a simple IIR filter with SciPy</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># Sampling time [seconds]</span>
<span class="n">Wn</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Cutoff frequency [Hz]</span>
<span class="n">order</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">Wn</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="n">analog</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>

<span class="c1"># Create &quot;template&quot; arguments for type inference</span>
<span class="n">u</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">u_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
<span class="n">y_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">u_prev</span><span class="p">,</span> <span class="n">y_prev</span><span class="p">)</span>

<span class="n">arc</span><span class="o">.</span><span class="n">codegen</span><span class="p">(</span><span class="n">iir_filter</span><span class="p">,</span> <span class="s2">&quot;iir_filter.c&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;main.c&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">main_c</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">display_text</span><span class="p">(</span><span class="n">main_c</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// gcc main.c iir_filter.c</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;iir_filter.h&quot;</span>

<span class="c1">// PROTECTED-REGION-START: imports</span>
<span class="c1">// ... User-defined imports and includes</span>
<span class="c1">// PROTECTED-REGION-END</span>

<span class="c1">// Allocate memory for inputs and outputs</span>
<span class="kt">double</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.20657208382614792</span><span class="p">,</span><span class="w"> </span><span class="mf">0.41314416765229584</span><span class="p">,</span><span class="w"> </span><span class="mf">0.20657208382614792</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.3695273773512414</span><span class="p">,</span><span class="w"> </span><span class="mf">0.19581571265583306</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">u_prev</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">y_prev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>

<span class="kt">double</span><span class="w"> </span><span class="n">u_hist</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">y_hist</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="c1">// Prepare pointers to inputs, outputs, and work arrays</span>
<span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">[</span><span class="n">iir_filter_SZ_ARG</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="p">[</span><span class="n">iir_filter_SZ_RES</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iw</span><span class="p">[</span><span class="n">iir_filter_SZ_IW</span><span class="p">];</span>
<span class="kt">double</span><span class="w"> </span><span class="n">w</span><span class="p">[</span><span class="n">iir_filter_SZ_W</span><span class="p">];</span>

<span class="c1">// PROTECTED-REGION-START: allocation</span>
<span class="c1">// ... User-defined memory allocation and function declaration</span>
<span class="c1">// PROTECTED-REGION-END</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Set up input and output pointers</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_prev</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_prev</span><span class="p">;</span>

<span class="w">    </span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_hist</span><span class="p">;</span>
<span class="w">    </span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_hist</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// PROTECTED-REGION-START: main</span>
<span class="w">    </span><span class="c1">// ... User-defined program body</span>
<span class="w">    </span><span class="n">iir_filter</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">iw</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// PROTECTED-REGION-END</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="protected-regions">
<h2>Protected regions<a class="headerlink" href="#protected-regions" title="Link to this heading">¶</a></h2>
<p>One unusual feature is the <code class="docutils literal notranslate"><span class="pre">PROTECTED-REGION-START</span></code> and <code class="docutils literal notranslate"><span class="pre">PROTECTED-REGION-END</span></code> comments.
These are used by Archimedes to bracked regions where you can modify the autogenerated code and your changes will be preserved.</p>
<p>Typical modifications you might make in protected regions include:</p>
<ol class="arabic simple">
<li><p><strong>Input/Output Handling</strong>: Adding code to read sensors or update actuators</p></li>
<li><p><strong>State Management</strong>: Copying outputs back to inputs for the next iteration</p></li>
<li><p><strong>Diagnostic Code</strong>: Adding debug output or performance measurements</p></li>
<li><p><strong>Interfacing with Other Sydstems</strong>: Communication code for UART, I2C, etc.</p></li>
</ol>
<p>Here’s an example where we will insert some code to copy the output back to the input arrays, as you would in a typical filtering application.
For this example we will insert this change programmatically using regex matching, but of course it will typically be easier to just make these changes by hand.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># New C code to insert</span>
<span class="n">new_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    // Call the IIR filter</span>
<span class="s2">    iir_filter(arg, res, iw, w, 0);</span>

<span class="s2">    // Copy the output to the input history arrays</span>
<span class="s2">    int n = sizeof(a) / sizeof(a[0]) - 1;</span>
<span class="s2">    for (int i = 0; i &lt; n; i++) {</span>
<span class="s2">        y_prev[i] = y_hist[i];</span>
<span class="s2">        u_prev[i] = u_hist[i];</span>
<span class="s2">    }</span>
<span class="s2">    u_prev[n] = u_hist[n];</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;main.c&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">main_c</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c1"># Replace the region content</span>
<span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(// PROTECTED-REGION-START: main\n)(.+?)(    // PROTECTED-REGION-END)&quot;</span>
<span class="n">main_c</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">1</span><span class="si">{</span><span class="n">new_code</span><span class="si">}</span><span class="se">\n\\</span><span class="s2">3&quot;</span><span class="p">,</span> <span class="n">main_c</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>

<span class="c1"># Write updated content back to file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;main.c&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">main_c</span><span class="p">)</span>

<span class="n">display_text</span><span class="p">(</span><span class="n">main_c</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// gcc main.c iir_filter.c</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;iir_filter.h&quot;</span>

<span class="c1">// PROTECTED-REGION-START: imports</span>
<span class="c1">// ... User-defined imports and includes</span>
<span class="c1">// PROTECTED-REGION-END</span>

<span class="c1">// Allocate memory for inputs and outputs</span>
<span class="kt">double</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.20657208382614792</span><span class="p">,</span><span class="w"> </span><span class="mf">0.41314416765229584</span><span class="p">,</span><span class="w"> </span><span class="mf">0.20657208382614792</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.3695273773512414</span><span class="p">,</span><span class="w"> </span><span class="mf">0.19581571265583306</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">u_prev</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">y_prev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>

<span class="kt">double</span><span class="w"> </span><span class="n">u_hist</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">y_hist</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="c1">// Prepare pointers to inputs, outputs, and work arrays</span>
<span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">[</span><span class="n">iir_filter_SZ_ARG</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="p">[</span><span class="n">iir_filter_SZ_RES</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iw</span><span class="p">[</span><span class="n">iir_filter_SZ_IW</span><span class="p">];</span>
<span class="kt">double</span><span class="w"> </span><span class="n">w</span><span class="p">[</span><span class="n">iir_filter_SZ_W</span><span class="p">];</span>

<span class="c1">// PROTECTED-REGION-START: allocation</span>
<span class="c1">// ... User-defined memory allocation and function declaration</span>
<span class="c1">// PROTECTED-REGION-END</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Set up input and output pointers</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_prev</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_prev</span><span class="p">;</span>

<span class="w">    </span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_hist</span><span class="p">;</span>
<span class="w">    </span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_hist</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// PROTECTED-REGION-START: main</span>

<span class="w">    </span><span class="c1">// Call the IIR filter</span>
<span class="w">    </span><span class="n">iir_filter</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">iw</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Copy the output to the input history arrays</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">y_prev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_hist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">u_prev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_hist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">u_prev</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_hist</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// PROTECTED-REGION-END</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we can change the Python code and re-generate the C, but our protected code will be preserved.  For example, let’s go back to a 3rd-order filter with a 10 Hz cutoff frequency:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Design a simple IIR filter with SciPy</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># Sampling time [seconds]</span>
<span class="n">Wn</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Cutoff frequency [Hz]</span>
<span class="n">order</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">Wn</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="n">analog</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>

<span class="c1"># Create &quot;template&quot; arguments for type inference</span>
<span class="n">u</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">u_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
<span class="n">y_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">u_prev</span><span class="p">,</span> <span class="n">y_prev</span><span class="p">)</span>

<span class="n">arc</span><span class="o">.</span><span class="n">codegen</span><span class="p">(</span><span class="n">iir_filter</span><span class="p">,</span> <span class="s2">&quot;iir_filter.c&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;main.c&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">main_c</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">display_text</span><span class="p">(</span><span class="n">main_c</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// gcc main.c iir_filter.c</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;iir_filter.h&quot;</span>

<span class="c1">// PROTECTED-REGION-START: imports</span>
<span class="c1">// ... User-defined imports and includes</span>
<span class="c1">// PROTECTED-REGION-END</span>

<span class="c1">// Allocate memory for inputs and outputs</span>
<span class="kt">double</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.018098933007514428</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05429679902254328</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05429679902254328</span><span class="p">,</span><span class="w"> </span><span class="mf">0.018098933007514428</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.7600418803431688</span><span class="p">,</span><span class="w"> </span><span class="mf">1.182893262037831</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.27805991763454646</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">u_prev</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">y_prev</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>

<span class="kt">double</span><span class="w"> </span><span class="n">u_hist</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">y_hist</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="c1">// Prepare pointers to inputs, outputs, and work arrays</span>
<span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">[</span><span class="n">iir_filter_SZ_ARG</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="p">[</span><span class="n">iir_filter_SZ_RES</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iw</span><span class="p">[</span><span class="n">iir_filter_SZ_IW</span><span class="p">];</span>
<span class="kt">double</span><span class="w"> </span><span class="n">w</span><span class="p">[</span><span class="n">iir_filter_SZ_W</span><span class="p">];</span>

<span class="c1">// PROTECTED-REGION-START: allocation</span>
<span class="c1">// ... User-defined memory allocation and function declaration</span>
<span class="c1">// PROTECTED-REGION-END</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Set up input and output pointers</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_prev</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_prev</span><span class="p">;</span>

<span class="w">    </span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_hist</span><span class="p">;</span>
<span class="w">    </span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_hist</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// PROTECTED-REGION-START: main</span>
<span class="w">    </span><span class="c1">// Call the IIR filter</span>
<span class="w">    </span><span class="n">iir_filter</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">iw</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Copy the output to the input history arrays</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">y_prev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_hist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">u_prev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_hist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">u_prev</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_hist</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
<span class="w">    </span><span class="c1">// PROTECTED-REGION-END</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The beauty of this approach is that you can regenerate the C code whenever your algorithm changes, without losing these customizations.</p>
</section>
<section id="working-with-templates">
<h2>Working with templates<a class="headerlink" href="#working-with-templates" title="Link to this heading">¶</a></h2>
<p>This combination allows you to switch seamlessly between the high-level Python and low-level C.
One limitation is that you are limited to the <em>original</em> protected regions in the template file, so if you want to make more extensive changes or define your own protected regions you may want to create your own template files.</p>
<p>The template files are in standard Jinja2 format; you can copy them and just point the code generation to your own custom template if you would like.  For example, <code class="docutils literal notranslate"><span class="pre">c_driver_custom.j2</span></code> is a lightly modified version of the default C template that calls the generated function inside of an infinite loop at approximately the sampling frequency (without accounting for the runtime of the filter itself).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cleanup</span><span class="p">()</span>  <span class="c1"># Cleanup any previous runs</span>

<span class="n">driver_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sample_rate&quot;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
    <span class="s2">&quot;template_path&quot;</span><span class="p">:</span> <span class="s2">&quot;c_driver_custom.j2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;output_path&quot;</span><span class="p">:</span> <span class="s2">&quot;main_custom.c&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">arc</span><span class="o">.</span><span class="n">codegen</span><span class="p">(</span><span class="n">iir_filter</span><span class="p">,</span> <span class="s2">&quot;iir_filter.c&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">driver_config</span><span class="o">=</span><span class="n">driver_config</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">driver_config</span><span class="p">[</span><span class="s2">&quot;output_path&quot;</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">main_c</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">display_text</span><span class="p">(</span><span class="n">main_c</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// gcc main_custom.c iir_filter.c</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;iir_filter.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="c1">// PROTECTED-REGION-START: imports</span>
<span class="c1">// ... User-defined imports and includes</span>
<span class="c1">// PROTECTED-REGION-END</span>

<span class="c1">// Sampling rate: 100 Hz</span>
<span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">SAMPLE_RATE_US</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>

<span class="c1">// Allocate memory for inputs and outputs</span>
<span class="kt">double</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.018098933007514428</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05429679902254328</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05429679902254328</span><span class="p">,</span><span class="w"> </span><span class="mf">0.018098933007514428</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.7600418803431688</span><span class="p">,</span><span class="w"> </span><span class="mf">1.182893262037831</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.27805991763454646</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">u_prev</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">y_prev</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>

<span class="kt">double</span><span class="w"> </span><span class="n">u_hist</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">double</span><span class="w"> </span><span class="n">y_hist</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="c1">// Prepare pointers to inputs, outputs, and work arrays</span>
<span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">[</span><span class="n">iir_filter_SZ_ARG</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="p">[</span><span class="n">iir_filter_SZ_RES</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iw</span><span class="p">[</span><span class="n">iir_filter_SZ_IW</span><span class="p">];</span>
<span class="kt">double</span><span class="w"> </span><span class="n">w</span><span class="p">[</span><span class="n">iir_filter_SZ_W</span><span class="p">];</span>

<span class="c1">// PROTECTED-REGION-START: allocation</span>
<span class="c1">// ... User-defined memory allocation and function declaration</span>
<span class="c1">// PROTECTED-REGION-END</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Set up input and output pointers</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_prev</span><span class="p">;</span>
<span class="w">    </span><span class="n">arg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_prev</span><span class="p">;</span>

<span class="w">    </span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_hist</span><span class="p">;</span>
<span class="w">    </span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_hist</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// PROTECTED-REGION-START: loop</span>
<span class="w">        </span><span class="c1">// ... User-defined program body</span>
<span class="w">        </span><span class="n">iir_filter</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">iw</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Sleep for the specified sample rate</span>
<span class="w">        </span><span class="n">usleep</span><span class="p">(</span><span class="n">SAMPLE_RATE_US</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// PROTECTED-REGION-END</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h2>
<p>In this part of the hardware deployment tutorial, we covered the basic mechanisms of creating “driver” code to call the auto-generated C code.
The auto-generated driver code will likely need to be modified for your specific use case; there are two basic mechanisms for customizing the driver code while preserving the ability to modify your high-level Python algorithms:</p>
<ol class="arabic simple">
<li><p><strong>Protected regions</strong>: Everything between <code class="docutils literal notranslate"><span class="pre">PROTECTED-REGION-*</span></code> tags in the driver file will be preserved by <code class="docutils literal notranslate"><span class="pre">codegen</span></code>, meaning that you can manually edit these parts of the code, re-generate your C code, and your edits will be preserved.</p></li>
<li><p><strong>Custom templates</strong>: For more extensive or structural modifications, the Jinja2 templates themselves can be modified.</p></li>
</ol>
<p>Combining these customizable driver templates with Python-to-C code generation provides a flexible tool kit for writing high-level logic in Python and then rapidly deploying to a C environment.
However, hardware control applications typically require going beyond plain C code and targeting an embedded processor.
In the final part of this tutorial we will bring it all together and see a simple example of auto-generating code for an Arduino development board.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cleanup</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="deployment03.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Platform-specific deployment templates</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="deployment01.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Generating C code</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Pine Tree Labs, LLC
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Generating driver code</a><ul>
<li><a class="reference internal" href="#protected-regions">Protected regions</a></li>
<li><a class="reference internal" href="#working-with-templates">Working with templates</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>