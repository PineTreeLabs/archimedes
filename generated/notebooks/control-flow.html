<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="author" title="About these documents" href="../../about.html" /><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="Hierarchical Design Patterns" href="modular-design.html" /><link rel="prev" title="Working with PyTrees" href="../../pytrees.html" />

    <link rel="shortcut icon" href="../../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>Structured Control Flow - Archimedes documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=c2950814" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #D35400;
  --color-brand-content: #C0392B;
  --color-admonition-background: rgba(211, 84, 0, 0.1);
  --color-background-primary: #F5F5F5;
  --color-background-secondary: #EEEEEE;
  --color-foreground-primary: #2A2A2A;
  --color-foreground-secondary: #5D4037;
  --color-link: #C0392B;
  --color-link-hover: #D35400;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #F1C40F;
  --color-brand-content: #D35400;
  --color-admonition-background: rgba(241, 196, 15, 0.1);
  --color-background-primary: #2A2A2A;
  --color-background-secondary: #1A1A1A;
  --color-foreground-primary: #F5F5F5;
  --color-foreground-secondary: #DDDDDD;
  --color-link: #D35400;
  --color-link-hover: #F1C40F;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #F1C40F;
  --color-brand-content: #D35400;
  --color-admonition-background: rgba(241, 196, 15, 0.1);
  --color-background-primary: #2A2A2A;
  --color-background-secondary: #1A1A1A;
  --color-foreground-primary: #F5F5F5;
  --color-foreground-secondary: #DDDDDD;
  --color-link: #D35400;
  --color-link-hover: #F1C40F;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Archimedes  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
    <div class="sidebar-brand-container">
      <img class="sidebar-logo" src="../../_static/logo.png" alt="Logo"/>
      <div class="sidebar-brand-text">Archimedes</div>
    </div>
  </a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">What is Archimedes?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting Started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Concepts</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../under-the-hood.html">Under the Hood</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pytrees.html">Working with PyTrees</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Structured Control Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="modular-design.html">Hierarchical Design Patterns</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../notebooks/multirotor/multirotor00.html">Multirotor Dynamics</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Multirotor Dynamics</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/multirotor/multirotor01.html">Part 1: Fundamentals of multirotor dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/multirotor/multirotor02.html">Part 2: Implementation in Archimedes</a></li>
<li class="toctree-l2"><a class="reference internal" href="multirotor/multirotor03.html">Part 3: Running the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="multirotor/multirotor04.html">Part 4: Model analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="multirotor/multirotor05.html">Part 5: Revisiting the rotor model (optional)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/multirotor/multirotor06.html">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../notebooks/deployment/deployment00.html">Deploying to Hardware</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Deploying to Hardware</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="deployment/deployment01.html">Generating C code</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment/deployment02.html">Generating driver code</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment/deployment03.html">Platform-specific deployment templates</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gotchas.html">üî™ Quirks and Gotchas</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../reference/index.html">üìö API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of üìö API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.codegen.html">archimedes.codegen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.array.html">archimedes.array</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.sym.html">archimedes.sym</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.sym_like.html">archimedes.sym_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.zeros.html">archimedes.zeros</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.ones.html">archimedes.ones</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.zeros_like.html">archimedes.zeros_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.ones_like.html">archimedes.ones_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.eye.html">archimedes.eye</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.scan.html">archimedes.scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.switch.html">archimedes.switch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.vmap.html">archimedes.vmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.compile.html">archimedes.compile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.callback.html">archimedes.callback</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.grad.html">archimedes.grad</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.jac.html">archimedes.jac</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.hess.html">archimedes.hess</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.jvp.html">archimedes.jvp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.vjp.html">archimedes.vjp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.interpolant.html">archimedes.interpolant</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.integrator.html">archimedes.integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.odeint.html">archimedes.odeint</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.nlp_solver.html">archimedes.nlp_solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.minimize.html">archimedes.minimize</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.implicit.html">archimedes.implicit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.root.html">archimedes.root</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/archimedes.qpsol.html">archimedes.qpsol</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/archimedes.tree.html">archimedes.tree</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of archimedes.tree</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.all.html">archimedes.tree.all</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.flatten.html">archimedes.tree.flatten</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.leaves.html">archimedes.tree.leaves</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.map.html">archimedes.tree.map</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.ravel.html">archimedes.tree.ravel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.reduce.html">archimedes.tree.reduce</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.register_dataclass.html">archimedes.tree.register_dataclass</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.register_pytree_node.html">archimedes.tree.register_pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.structure.html">archimedes.tree.structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.unflatten.html">archimedes.tree.unflatten</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/archimedes.tree.struct.html">archimedes.tree.struct</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of archimedes.tree.struct</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.struct.dataclass_transform.html">archimedes.tree.struct.dataclass_transform</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.struct.field.html">archimedes.tree.struct.field</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.struct.fields.html">archimedes.tree.struct.fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.struct.is_pytree_node.html">archimedes.tree.struct.is_pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.struct.pytree_node.html">archimedes.tree.struct.pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.struct.register_dataclass.html">archimedes.tree.struct.register_dataclass</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.struct.replace.html">archimedes.tree.struct.replace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.struct.Any.html">archimedes.tree.struct.Any</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.struct.Callable.html">archimedes.tree.struct.Callable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.struct.InitVar.html">archimedes.tree.struct.InitVar</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/archimedes.tree.struct.TypeVar.html">archimedes.tree.struct.TypeVar</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Development Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../licensing-model.html">Licensing model</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../../_sources/generated/notebooks/control-flow.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="structured-control-flow">
<h1>Structured Control Flow<a class="headerlink" href="#structured-control-flow" title="Link to this heading">¬∂</a></h1>
<p>Control flow is a fundamental aspect of programming, allowing us to make decisions (if/else) and repeat operations (loops). However, in symbolic computation frameworks like Archimedes, standard Python control flow constructs don‚Äôt work as expected. This page explains why this happens and introduces structured control flow mechanisms that enable these patterns in a symbolic-computation-friendly way.</p>
<p>Note that much of the design of these control flow functions is based on JAX; it may be worth taking a look at <a class="reference external" href="https://docs.jax.dev/en/latest/control-flow.html">the JAX documentation on control flow</a> for further reading.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">arc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="kn">import</span> <span class="n">struct</span>
</pre></div>
</div>
<section id="the-problem-with-standard-control-flow">
<h2>The Problem with Standard Control Flow<a class="headerlink" href="#the-problem-with-standard-control-flow" title="Link to this heading">¬∂</a></h2>
<p>When working with symbolic computation, Python‚Äôs standard control flow constructs often fail because they require evaluating conditions on symbolic values, which cannot be directly converted to boolean values. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># This doesn&#39;t work! x is symbolic here</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Incorrect!</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(array(0.54030231), np.float64(0.8414709848078965))
</pre></div>
</div>
<p>This fails because <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;</span> <span class="pre">0</span></code> produces a symbolic expression representing the condition, not a concrete <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code> value that Python‚Äôs <code class="docutils literal notranslate"><span class="pre">if</span></code> statement requires.</p>
<p>Similarly, loops with symbolic bounds or termination conditions don‚Äôt work:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># Error: x is symbolic, can&#39;t be converted to int</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">y</span>


<span class="k">try</span><span class="p">:</span>
    <span class="n">f</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Error: &#39;SymbolicArray&#39; object cannot be interpreted as an integer
</pre></div>
</div>
</section>
<section id="when-you-can-use-standard-python-loops">
<h2>When You Can Use Standard Python Loops<a class="headerlink" href="#when-you-can-use-standard-python-loops" title="Link to this heading">¬∂</a></h2>
<p>Despite these limitations, standard Python loops can be used in specific cases:</p>
<ol class="arabic simple">
<li><p>When loop bounds are static (known at compile time)</p></li>
<li><p>When the loop iteration count doesn‚Äôt depend on symbolic values</p></li>
<li><p>When there‚Äôs no early termination based on symbolic conditions</p></li>
</ol>
<p>For example, this will work:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>  <span class="c1"># Fixed, static bound</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">y</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>array(15)
</pre></div>
</div>
<p>However, even when loops are structurally valid, using standard Python loops inside compiled functions can lead to large computational graphs, which may impact performance and memory usage.</p>
</section>
<section id="structured-control-flow-mechanisms">
<h2>Structured Control Flow Mechanisms<a class="headerlink" href="#structured-control-flow-mechanisms" title="Link to this heading">¬∂</a></h2>
<p>Archimedes provides three primary mechanisms for structured control flow:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.where.html#numpy.where" title="NumPy 2.2"><span class="xref myst"><code class="docutils literal notranslate"><span class="pre">np.where</span></code></span></a> - For element-wise conditional operations</p></li>
<li><p><a class="reference internal" href="../api/archimedes.scan.html#archimedes.scan" title="archimedes.scan"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">scan</span></code></span></a> - For iterative computations (similar to functional fold/reduce)</p></li>
<li><p><a class="reference internal" href="../api/archimedes.switch.html#archimedes.switch" title="archimedes.switch"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">switch</span></code></span></a> - For selecting between multiple computational branches</p></li>
<li><p><a class="reference internal" href="../api/archimedes.vmap.html#archimedes.vmap" title="archimedes.vmap"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">vmap</span></code></span></a> - For vectorizing operations across batch dimensions</p></li>
</ol>
<p>Let‚Äôs explore each of these in detail.</p>
<section id="iterative-computation-with-scan">
<h3>Iterative Computation with <a class="reference internal" href="../api/archimedes.scan.html#archimedes.scan" title="archimedes.scan"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">scan</span></code></span></a><a class="headerlink" href="#iterative-computation-with-scan" title="Link to this heading">¬∂</a></h3>
<p>For loops and iterative algorithms, <a class="reference internal" href="../api/archimedes.scan.html#archimedes.scan" title="archimedes.scan"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">scan</span></code></span></a> provides a functional way to express loops that are compatible with symbolic computation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a function for a single iteration</span>
<span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">iteration_step</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">new_carry</span> <span class="o">=</span> <span class="n">carry</span> <span class="o">+</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">new_carry</span><span class="p">,</span> <span class="n">new_carry</span>  <span class="c1"># Return both state and output</span>


<span class="c1"># Apply this function repeatedly</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="n">final_state</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">iteration_step</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">final_state</span><span class="p">)</span>  <span class="c1"># 15 (sum of all values)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>  <span class="c1"># [1, 3, 6, 10, 15] (running sum)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>15
[ 1  3  6 10 15]
</pre></div>
</div>
<p><a class="reference internal" href="../api/archimedes.scan.html#archimedes.scan" title="archimedes.scan"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">scan</span></code></span></a> takes a function with the signature <code class="docutils literal notranslate"><span class="pre">f(carry,</span> <span class="pre">x)</span> <span class="pre">-&gt;</span> <span class="pre">(new_carry,</span> <span class="pre">y)</span></code>, applies it to each element of <code class="docutils literal notranslate"><span class="pre">xs</span></code> (or for a specified number of iterations), and returns the final state and all intermediate outputs <code class="docutils literal notranslate"><span class="pre">ys</span></code>.</p>
<p>This is useful for constructing efficient computational graphs when there is a loop with many iterations; the <a class="reference internal" href="../api/archimedes.scan.html#archimedes.scan" title="archimedes.scan"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">scan</span></code></span></a> operation condenses all of these to a single node in the computational graph, compared to one node per loop iteration.</p>
</section>
<section id="conditional-logic-with-np-where">
<h3>Conditional Logic with <code class="docutils literal notranslate"><span class="pre">np.where</span></code><a class="headerlink" href="#conditional-logic-with-np-where" title="Link to this heading">¬∂</a></h3>
<p>The simplest way to implement conditional logic is using NumPy‚Äôs <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.where.html#numpy.where" title="NumPy 2.2"><span class="xref myst"><code class="docutils literal notranslate"><span class="pre">where</span></code></span></a> function, which works with symbolic values:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0.8414709848078965 0.8414709848078965
0.5403023058681398 0.5403023058681398
</pre></div>
</div>
<p>This approach works for simple conditionals but becomes unwieldy for complex branching logic or when the branches involve substantial computation.</p>
</section>
<section id="branch-selection-with-switch">
<h3>Branch Selection with <a class="reference internal" href="../api/archimedes.switch.html#archimedes.switch" title="archimedes.switch"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">switch</span></code></span></a><a class="headerlink" href="#branch-selection-with-switch" title="Link to this heading">¬∂</a></h3>
<p>For more complex conditional branching, where different functions need to be applied based on an index value, <a class="reference internal" href="../api/archimedes.switch.html#archimedes.switch" title="archimedes.switch"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">switch</span></code></span></a> provides a clean solution:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_operation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">op_index</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">arc</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span>
        <span class="n">op_index</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># Branch 0</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>  <span class="c1"># Branch 1</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">,</span>
        <span class="p">),</span>  <span class="c1"># Branch 2</span>
        <span class="n">x</span><span class="p">,</span>
    <span class="p">)</span>


<span class="c1"># Call with different branch indices</span>
<span class="n">result0</span> <span class="o">=</span> <span class="n">apply_operation</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 4.0 (square)</span>
<span class="n">result1</span> <span class="o">=</span> <span class="n">apply_operation</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># ~0.91 (sine)</span>
<span class="n">result2</span> <span class="o">=</span> <span class="n">apply_operation</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># -2.0 (negate)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">result0</span><span class="p">,</span> <span class="n">result1</span><span class="p">,</span> <span class="n">result2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>4.0 0.9092974268256817 -2.0
</pre></div>
</div>
<p><a class="reference internal" href="../api/archimedes.switch.html#archimedes.switch" title="archimedes.switch"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">switch</span></code></span></a> evaluates all branches during compilation to ensure they return compatible outputs, but at runtime, only the selected branch executes (i.e. evaluation is ‚Äúshort-circuiting‚Äù).</p>
</section>
<section id="vectorization-with-vmap">
<h3>Vectorization with <a class="reference internal" href="../api/archimedes.vmap.html#archimedes.vmap" title="archimedes.vmap"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">vmap</span></code></span></a><a class="headerlink" href="#vectorization-with-vmap" title="Link to this heading">¬∂</a></h3>
<p>For applying the same operation to multiple inputs in parallel, <a class="reference internal" href="../api/archimedes.vmap.html#archimedes.vmap" title="archimedes.vmap"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">vmap</span></code></span></a> transforms a function that works on single elements into one that works on batches:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="c1"># Vectorize to compute multiple dot products at once</span>
<span class="n">batched_dot</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span>

<span class="c1"># Input: batch of vectors (3 vectors of length 2)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]])</span>

<span class="c1"># Output: batch of scalars (3 dot products)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">batched_dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>  <span class="c1"># [23, 67, 127]</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[ 23  67 127]
</pre></div>
</div>
</section>
</section>
<section id="common-control-flow-patterns">
<h2>Common Control Flow Patterns<a class="headerlink" href="#common-control-flow-patterns" title="Link to this heading">¬∂</a></h2>
<p>Now let‚Äôs look at how to implement common control flow patterns using these mechanisms.</p>
<section id="implementing-if-else-logic">
<h3>Implementing if/else logic<a class="headerlink" href="#implementing-if-else-logic" title="Link to this heading">¬∂</a></h3>
<p>As mentioned above, for simple conditionals it is easiest to use <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.where.html#numpy.where" title="NumPy 2.2"><span class="xref myst"><code class="docutils literal notranslate"><span class="pre">np.where</span></code></span></a>.  However, when the branches are more complex, an <code class="docutils literal notranslate"><span class="pre">if_else</span></code> function can be constructed with <a class="reference internal" href="../api/archimedes.switch.html#archimedes.switch" title="archimedes.switch"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">switch</span></code></span></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">true_branch</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<span class="k">def</span><span class="w"> </span><span class="nf">false_branch</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span>


<span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="c1"># Convert boolean condition to 0/1 index</span>
    <span class="k">return</span> <span class="n">arc</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="p">(</span><span class="n">false_branch</span><span class="p">,</span> <span class="n">true_branch</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># Returns 5 (true branch)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># Returns -1 (false branch)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>5
-1
</pre></div>
</div>
</section>
<section id="creating-a-bounded-while-loop">
<h3>Creating a Bounded While Loop<a class="headerlink" href="#creating-a-bounded-while-loop" title="Link to this heading">¬∂</a></h3>
<p>While <a class="reference internal" href="../api/archimedes.scan.html#archimedes.scan" title="archimedes.scan"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">scan</span></code></span></a> typically iterates for a fixed number of steps, you can implement a bounded while loop by carrying a condition flag and using early-return values:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">static_argnames</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;loop_func&quot;</span><span class="p">,</span> <span class="s2">&quot;max_iterations&quot;</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">bounded_while</span><span class="p">(</span><span class="n">loop_func</span><span class="p">,</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">body</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="c1"># Unpack state: (value, done)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="n">state</span>

        <span class="c1"># Compute new value if not done</span>
        <span class="n">new_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">done</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">loop_func</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="c1"># Check termination condition (with a maximum iteration bound)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">done</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">new_x</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Return updated state and the current value</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">done</span><span class="p">),</span> <span class="n">new_x</span>

    <span class="c1"># Initialize with not-done flag</span>
    <span class="n">init_full_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">init_state</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Run the scan for the maximum number of iterations</span>
    <span class="n">final_state</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">init_full_state</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">max_iterations</span><span class="p">)</span>

    <span class="c1"># Return the final converged value</span>
    <span class="k">return</span> <span class="n">final_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="vectorizing-pytree-operations">
<h3>Vectorizing PyTree Operations<a class="headerlink" href="#vectorizing-pytree-operations" title="Link to this heading">¬∂</a></h3>
<p>When working with structured data represented as PyTrees, <a class="reference internal" href="../api/archimedes.vmap.html#archimedes.vmap" title="archimedes.vmap"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">vmap</span></code></span></a> is particularly useful:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Particle</span><span class="p">:</span>
    <span class="n">pos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">vel</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>


<span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">new_pos</span> <span class="o">=</span> <span class="n">particle</span><span class="o">.</span><span class="n">pos</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">particle</span><span class="o">.</span><span class="n">vel</span>
    <span class="k">return</span> <span class="n">Particle</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">new_pos</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="n">particle</span><span class="o">.</span><span class="n">vel</span><span class="p">)</span>


<span class="c1"># Create a batch of particles</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># 100 particles in 3D space</span>
<span class="n">velocities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">particles</span> <span class="o">=</span> <span class="n">Particle</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="n">velocities</span><span class="p">)</span>

<span class="c1"># Update all particles at once</span>
<span class="n">batch_update</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="n">new_particles</span> <span class="o">=</span> <span class="n">batch_update</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="../api/archimedes.vmap.html#archimedes.vmap" title="archimedes.vmap"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">vmap</span></code></span></a> can also be used to batch-unravel flat arrays, for example the results of a simulation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x0</span> <span class="o">=</span> <span class="n">Particle</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="n">vel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]))</span>

<span class="c1"># Flatten the single particle</span>
<span class="n">x0_flat</span><span class="p">,</span> <span class="n">unravel</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

<span class="c1"># Dummy data in the shape of a simulation result</span>
<span class="n">xs_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># 4 timesteps, 100 particles</span>

<span class="c1"># We cannot directly unravel the data</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">x0_unraveled</span> <span class="o">=</span> <span class="n">unravel</span><span class="p">(</span><span class="n">xs_flat</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

<span class="c1"># Instead use vmap:</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">unravel</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">xs_flat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># (2, 100)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Error: cannot reshape array of size 200 into shape (2,)
(2, 100)
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="modular-design.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Hierarchical Design Patterns</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../../pytrees.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Working with PyTrees</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Pine Tree Labs, LLC
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Structured Control Flow</a><ul>
<li><a class="reference internal" href="#the-problem-with-standard-control-flow">The Problem with Standard Control Flow</a></li>
<li><a class="reference internal" href="#when-you-can-use-standard-python-loops">When You Can Use Standard Python Loops</a></li>
<li><a class="reference internal" href="#structured-control-flow-mechanisms">Structured Control Flow Mechanisms</a><ul>
<li><a class="reference internal" href="#iterative-computation-with-scan">Iterative Computation with <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">scan</span></code></span></a></li>
<li><a class="reference internal" href="#conditional-logic-with-np-where">Conditional Logic with <code class="docutils literal notranslate"><span class="pre">np.where</span></code></a></li>
<li><a class="reference internal" href="#branch-selection-with-switch">Branch Selection with <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">switch</span></code></span></a></li>
<li><a class="reference internal" href="#vectorization-with-vmap">Vectorization with <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">vmap</span></code></span></a></li>
</ul>
</li>
<li><a class="reference internal" href="#common-control-flow-patterns">Common Control Flow Patterns</a><ul>
<li><a class="reference internal" href="#implementing-if-else-logic">Implementing if/else logic</a></li>
<li><a class="reference internal" href="#creating-a-bounded-while-loop">Creating a Bounded While Loop</a></li>
<li><a class="reference internal" href="#vectorizing-pytree-operations">Vectorizing PyTree Operations</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>