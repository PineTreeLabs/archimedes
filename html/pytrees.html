<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="author" title="About these documents" href="about.html" /><link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Structured Control Flow" href="generated/notebooks/control-flow.html" /><link rel="prev" title="Under the Hood" href="under-the-hood.html" />

    <link rel="shortcut icon" href="_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>Working with PyTrees - Archimedes documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=c2950814" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #D35400;
  --color-brand-content: #C0392B;
  --color-admonition-background: rgba(211, 84, 0, 0.1);
  --color-background-primary: #F5F5F5;
  --color-background-secondary: #EEEEEE;
  --color-foreground-primary: #2A2A2A;
  --color-foreground-secondary: #5D4037;
  --color-link: #C0392B;
  --color-link-hover: #D35400;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #F1C40F;
  --color-brand-content: #D35400;
  --color-admonition-background: rgba(241, 196, 15, 0.1);
  --color-background-primary: #2A2A2A;
  --color-background-secondary: #1A1A1A;
  --color-foreground-primary: #F5F5F5;
  --color-foreground-secondary: #DDDDDD;
  --color-link: #D35400;
  --color-link-hover: #F1C40F;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #F1C40F;
  --color-brand-content: #D35400;
  --color-admonition-background: rgba(241, 196, 15, 0.1);
  --color-background-primary: #2A2A2A;
  --color-background-secondary: #1A1A1A;
  --color-foreground-primary: #F5F5F5;
  --color-foreground-secondary: #DDDDDD;
  --color-link: #D35400;
  --color-link-hover: #F1C40F;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Archimedes  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
    <div class="sidebar-brand-container">
      <img class="sidebar-logo" src="_static/logo.png" alt="Logo"/>
      <div class="sidebar-brand-text">Archimedes</div>
    </div>
  </a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">What is Archimedes?</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Concepts</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="under-the-hood.html">Under the Hood</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Working with PyTrees</a></li>
<li class="toctree-l1"><a class="reference internal" href="generated/notebooks/control-flow.html">Structured Control Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="generated/notebooks/modular-design.html">Hierarchical Design Patterns</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="notebooks/multirotor/multirotor00.html">Multirotor Dynamics</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Multirotor Dynamics</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="notebooks/multirotor/multirotor01.html">Part 1: Fundamentals of multirotor dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/multirotor/multirotor02.html">Part 2: Implementation in Archimedes</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/notebooks/multirotor/multirotor03.html">Part 3: Running the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/notebooks/multirotor/multirotor04.html">Part 4: Model analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/notebooks/multirotor/multirotor05.html">Part 5: Revisiting the rotor model (optional)</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/multirotor/multirotor06.html">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="notebooks/deployment/deployment00.html">Deploying to Hardware</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Deploying to Hardware</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="generated/notebooks/deployment/deployment01.html">Generating C code</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/notebooks/deployment/deployment02.html">Generating driver code</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/notebooks/deployment/deployment03.html">Platform-specific deployment templates</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="gotchas.html">üî™ Quirks and Gotchas</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="reference/index.html">üìö API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of üìö API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.codegen.html">archimedes.codegen</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.array.html">archimedes.array</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.sym.html">archimedes.sym</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.sym_like.html">archimedes.sym_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.zeros.html">archimedes.zeros</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.ones.html">archimedes.ones</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.zeros_like.html">archimedes.zeros_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.ones_like.html">archimedes.ones_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.eye.html">archimedes.eye</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.scan.html">archimedes.scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.switch.html">archimedes.switch</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.vmap.html">archimedes.vmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.compile.html">archimedes.compile</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.callback.html">archimedes.callback</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.grad.html">archimedes.grad</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.jac.html">archimedes.jac</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.hess.html">archimedes.hess</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.jvp.html">archimedes.jvp</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.vjp.html">archimedes.vjp</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.interpolant.html">archimedes.interpolant</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.integrator.html">archimedes.integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.odeint.html">archimedes.odeint</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.nlp_solver.html">archimedes.nlp_solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.minimize.html">archimedes.minimize</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.implicit.html">archimedes.implicit</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.root.html">archimedes.root</a></li>
<li class="toctree-l2"><a class="reference internal" href="generated/api/archimedes.qpsol.html">archimedes.qpsol</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="generated/api/archimedes.tree.html">archimedes.tree</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of archimedes.tree</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.all.html">archimedes.tree.all</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.flatten.html">archimedes.tree.flatten</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.leaves.html">archimedes.tree.leaves</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.map.html">archimedes.tree.map</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.ravel.html">archimedes.tree.ravel</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.reduce.html">archimedes.tree.reduce</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.register_dataclass.html">archimedes.tree.register_dataclass</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.register_pytree_node.html">archimedes.tree.register_pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.structure.html">archimedes.tree.structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.unflatten.html">archimedes.tree.unflatten</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="generated/api/archimedes.tree.struct.html">archimedes.tree.struct</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of archimedes.tree.struct</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.dataclass_transform.html">archimedes.tree.struct.dataclass_transform</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.field.html">archimedes.tree.struct.field</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.fields.html">archimedes.tree.struct.fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.is_pytree_node.html">archimedes.tree.struct.is_pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.pytree_node.html">archimedes.tree.struct.pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.register_dataclass.html">archimedes.tree.struct.register_dataclass</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.replace.html">archimedes.tree.struct.replace</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.Any.html">archimedes.tree.struct.Any</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.Callable.html">archimedes.tree.struct.Callable</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.InitVar.html">archimedes.tree.struct.InitVar</a></li>
<li class="toctree-l3"><a class="reference internal" href="generated/api/archimedes.tree.struct.TypeVar.html">archimedes.tree.struct.TypeVar</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Development Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="licensing-model.html">Licensing model</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/pytrees.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="working-with-pytrees">
<h1>Working with PyTrees<a class="headerlink" href="#working-with-pytrees" title="Link to this heading">¬∂</a></h1>
<p>PyTrees in Archimedes provide a way to work with structured data in numerical algorithms that typically expect flat vectors. This page explains what PyTrees are, how to use them in your code, and how to create custom structures that work seamlessly with Archimedes functions.</p>
<p>The Archimedes concept of a PyTree is borrowed from <a class="reference external" href="https://docs.jax.dev/en/latest/pytrees.html">JAX</a>, while the <code class="docutils literal notranslate"><span class="pre">pytree_node</span></code> decorator produces composable classes that work similarly to <a class="reference external" href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html">PyTorch Modules</a>.
You may also want to scan these documentation pages to get ideas about what these structures are and how they are used.</p>
<section id="what-is-a-pytree">
<h2>What is a PyTree?<a class="headerlink" href="#what-is-a-pytree" title="Link to this heading">¬∂</a></h2>
<p>A PyTree is any nested structure of ‚Äúcontainers‚Äù (dictionaries, lists, tuples, NamedTuples) and ‚Äúleaves‚Äù (arrays or scalars). Archimedes automatically recognizes built-in Python containers as PyTree nodes, while arrays and scalars are treated as leaves.</p>
<p>Examples of valid PyTrees:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># A list of scalars</span>
<span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>  

<span class="c1"># A dictionary of arrays</span>
<span class="p">{</span><span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]),</span> <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])}</span>  

<span class="c1"># A nested structure with multiple container types</span>
<span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]),</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="flattening-and-unflattening">
<h2>Flattening and Unflattening<a class="headerlink" href="#flattening-and-unflattening" title="Link to this heading">¬∂</a></h2>
<p>The primary operations with PyTrees are:</p>
<ul class="simple">
<li><p><strong>Flattening</strong>: Converting a structured PyTree into a flat vector</p></li>
<li><p><strong>Unflattening</strong>: Restoring a flat vector to its original structure</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">arc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Create a structured state</span>
<span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]),</span> <span class="s2">&quot;vel&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])}</span>

<span class="c1"># Flatten to a vector</span>
<span class="n">flat_state</span><span class="p">,</span> <span class="n">unravel</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">flat_state</span><span class="p">)</span>  <span class="c1"># array([0., 1., 2., 3., 4., 5.])</span>

<span class="c1"># Restore the original structure</span>
<span class="n">restored_state</span> <span class="o">=</span> <span class="n">unravel</span><span class="p">(</span><span class="n">flat_state</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">restored_state</span><span class="p">)</span>  <span class="c1"># {&#39;pos&#39;: array([0., 1., 2.]), &#39;vel&#39;: array([3., 4., 5.])}</span>
</pre></div>
</div>
<p>This pattern is essential when working with:</p>
<ul class="simple">
<li><p>ODE solvers that require state vectors</p></li>
<li><p>Optimization algorithms operating on parameter vectors</p></li>
<li><p>Root-finding methods that expect flat systems</p></li>
</ul>
</section>
<section id="custom-pytree-types">
<h2>Custom PyTree Types<a class="headerlink" href="#custom-pytree-types" title="Link to this heading">¬∂</a></h2>
<p>For more complex models, create custom classes that work as PyTrees using the <code class="docutils literal notranslate"><span class="pre">struct.pytree_node</span></code> decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">archimedes.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">struct</span>

<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">VehicleState</span><span class="p">:</span>
    <span class="n">position</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>      <span class="c1"># [x, y, z]</span>
    <span class="n">velocity</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>      <span class="c1"># [vx, vy, vz]</span>
    <span class="n">attitude</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>      <span class="c1"># quaternion [qx, qy, qz, qw]</span>
    <span class="n">angular_velocity</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># [wx, wy, wz]</span>

<span class="c1"># Create an instance</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">VehicleState</span><span class="p">(</span>
    <span class="n">position</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">velocity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">attitude</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">angular_velocity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Flatten to a vector</span>
<span class="n">flat_state</span><span class="p">,</span> <span class="n">unravel</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="c1"># Use in compiled functions</span>
<span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dynamics</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="c1"># Access fields naturally</span>
    <span class="n">new_position</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">state</span><span class="o">.</span><span class="n">velocity</span>
    <span class="c1"># ...other calculations...</span>
    <span class="k">return</span> <span class="n">VehicleState</span><span class="p">(</span>
        <span class="n">position</span><span class="o">=</span><span class="n">new_position</span><span class="p">,</span>
        <span class="c1"># ...other updated fields...</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">struct.pytree_node</span></code> decorator automatically registers your class with Archimedes‚Äô PyTree system, combining the benefits of Python <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html">dataclasses</a> with PyTree functionality.</p>
<section id="custom-nodes-advanced-usage">
<h3>Custom nodes: advanced usage<a class="headerlink" href="#custom-nodes-advanced-usage" title="Link to this heading">¬∂</a></h3>
<p>Since the <code class="docutils literal notranslate"><span class="pre">pytree_node</span></code> decorator converts your class into a standard (frozen) Python dataclass, many typical dataclass considerations carry over directly to custom nodes.
For instance, you should typically avoid implementing <code class="docutils literal notranslate"><span class="pre">__init__</span></code> yourself (as this is constructed automatically by the dataclass), but you can implement <code class="docutils literal notranslate"><span class="pre">__post_init__</span></code> for custom initializations.</p>
<p>In addition, you can apply the usual <code class="docutils literal notranslate"><span class="pre">field</span></code> to any field defined for the node.
The <code class="docutils literal notranslate"><span class="pre">struct</span></code> module provides its own wrapper of <code class="docutils literal notranslate"><span class="pre">field</span></code>, which extends it with the ability to label a field as <code class="docutils literal notranslate"><span class="pre">static</span></code>.
Among other things, this means that it should not be included when translating to/from a flat vector.</p>
<p>These custom nodes are otherwise normal Python classes, so you can define methods on them as usual.</p>
<p>Here is an expanded example with some advanced features:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">arc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="kn">import</span> <span class="n">struct</span>

<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Rocket</span><span class="p">:</span>
    <span class="c1"># Dynamic variables (included in flattening)</span>
    <span class="n">h</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># height in meters</span>
    <span class="n">v</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># velocity in m/s</span>
    <span class="n">m</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Current mass in kg</span>
    
    <span class="c1"># Static parameters (excluded from flattening)</span>
    <span class="n">thrust</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">10000.0</span><span class="p">)</span>  <span class="c1"># Thrust in Newtons</span>
    <span class="n">isp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">300.0</span><span class="p">)</span>       <span class="c1"># Specific impulse in seconds</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Validate inputs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mass must be positive&quot;</span><span class="p">)</span>

<span class="c1"># Create a rocket state</span>
<span class="n">rocket</span> <span class="o">=</span> <span class="n">Rocket</span><span class="p">(</span>
    <span class="n">h</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">v</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">m</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span>
    <span class="n">thrust</span><span class="o">=</span><span class="mf">15000.0</span><span class="p">,</span>  <span class="c1"># Override the default</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">rocket</span><span class="p">)</span>  <span class="c1"># Rocket(h=0.0, v=0.0, m=1000.0, thrust=15000.0, isp=300.0)</span>

<span class="c1"># Flatten to vector - note that static fields are excluded</span>
<span class="n">flat_state</span><span class="p">,</span> <span class="n">unravel</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">rocket</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flat state shape: </span><span class="si">{</span><span class="n">flat_state</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># (3,) for height + velocity + mass</span>

<span class="c1"># Modify the flat state</span>
<span class="n">flat_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">10</span>  <span class="c1"># Increase height by 10 meters</span>

<span class="c1"># Unravel back to object - static fields are restored</span>
<span class="n">new_rocket</span> <span class="o">=</span> <span class="n">unravel</span><span class="p">(</span><span class="n">flat_state</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_rocket</span><span class="p">)</span>  <span class="c1"># Rocket(h=10.0, v=0.0, m=1000.0, thrust=15000.0, isp=300.0)</span>
</pre></div>
</div>
<p>You can also nest custom PyTree nodes within each other and define special methods like <code class="docutils literal notranslate"><span class="pre">__call__</span></code>, giving you the ability to create modular and reusable model components.
For example, if we wanted to simulate a rendezvous between our rocket and the ISS, we could create another PyTree node <code class="docutils literal notranslate"><span class="pre">Satellite</span></code> and the combined state of our system could be defined by a <code class="docutils literal notranslate"><span class="pre">NamedTuple</span></code>, making the entire composite state a valid PyTree:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedTuple</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Satellite</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">pos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">vel</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RendezvousState</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">rocket</span><span class="p">:</span> <span class="n">Rocket</span>
    <span class="n">satellite</span><span class="p">:</span> <span class="n">Satellite</span>

<span class="n">satellite</span> <span class="o">=</span> <span class="n">Satellite</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">vel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">RendezvousState</span><span class="p">(</span><span class="n">rocket</span><span class="p">,</span> <span class="n">satellite</span><span class="p">)</span>

<span class="n">flat_state</span><span class="p">,</span> <span class="n">unravel</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">flat_state</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># (9,): three from rocket and six from satellite</span>
</pre></div>
</div>
</section>
</section>
<section id="example-pendulum-simulation-using-pytrees">
<h2>Example: Pendulum Simulation Using PyTrees<a class="headerlink" href="#example-pendulum-simulation-using-pytrees" title="Link to this heading">¬∂</a></h2>
<p>Here‚Äôs how PyTrees simplify ODE solving with structured data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">arc</span>

<span class="c1"># Define a custom PyTree node with dynamics method</span>
<span class="nd">@arc</span><span class="o">.</span><span class="n">struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PendulumState</span><span class="p">:</span>
    <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span>      <span class="c1"># angle</span>
    <span class="n">omega</span><span class="p">:</span> <span class="nb">float</span>      <span class="c1"># angular velocity</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dynamics</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">g</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="mf">9.81</span><span class="p">,</span> <span class="mf">1.0</span>

        <span class="c1"># Calculate derivatives</span>
        <span class="n">theta_t</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">omega</span>
        <span class="n">omega_t</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">g</span><span class="o">/</span><span class="n">L</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span>

        <span class="c1"># Return in the same structure</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">theta</span><span class="o">=</span><span class="n">theta_t</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="n">omega_t</span><span class="p">)</span>

<span class="c1"># Initial state and simulation parameters</span>
<span class="n">initial_state</span> <span class="o">=</span> <span class="n">PendulumState</span><span class="p">(</span><span class="n">theta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">t_span</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
<span class="n">t_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">t_span</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># Convert to flat vector for solver</span>
<span class="n">x0</span><span class="p">,</span> <span class="n">unravel</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">initial_state</span><span class="p">)</span>

<span class="c1"># Create flat dynamics wrapper</span>
<span class="nd">@arc</span><span class="o">.</span><span class="n">compile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">flat_dynamics</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">unravel</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Unflatten to </span>
    <span class="n">derivatives</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">derivatives</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dx</span>  <span class="c1"># Return the flattened state</span>

<span class="c1"># Solve the ODE</span>
<span class="n">solution</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">odeint</span><span class="p">(</span><span class="n">flat_dynamics</span><span class="p">,</span> <span class="n">t_span</span><span class="o">=</span><span class="n">t_span</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">t_eval</span><span class="o">=</span><span class="n">t_eval</span><span class="p">)</span>

<span class="c1"># Convert results back to structured form and unpack</span>
<span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="n">unravel</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">solution</span><span class="o">.</span><span class="n">T</span><span class="p">]</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">state</span><span class="o">.</span><span class="n">theta</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">])</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">state</span><span class="o">.</span><span class="n">omega</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="current-limitations">
<h2>Current Limitations<a class="headerlink" href="#current-limitations" title="Link to this heading">¬∂</a></h2>
<p>The following limitations will be resolved with further development:</p>
<ul class="simple">
<li><p><strong>Postprocessing</strong>: The <code class="docutils literal notranslate"><span class="pre">unravel</span></code> functions assume that their arguments have the same shape as the original PyTree, leading to somewhat complicated unpacking operations, particularly for ODE solutions like the previous example.</p></li>
<li><p><strong>No automatic conversion</strong>: Functions like <code class="docutils literal notranslate"><span class="pre">odeint</span></code> and <code class="docutils literal notranslate"><span class="pre">minimize</span></code> don‚Äôt automatically convert all their arguments to PyTrees, meaning you have to manually construct wrapper functions like <code class="docutils literal notranslate"><span class="pre">flat_dynamics</span></code> above.</p></li>
</ul>
<p><strong>If you encounter what looks like a bug with PyTrees or another limitation, please file an issue!</strong></p>
</section>
<section id="best-practices-and-tips">
<h2>Best Practices and Tips<a class="headerlink" href="#best-practices-and-tips" title="Link to this heading">¬∂</a></h2>
<ul class="simple">
<li><p><strong>Structure Consistency</strong>: When unraveling, the flat array length must match the original PyTree structure</p></li>
<li><p><strong>Immutability</strong>: Treat PyTrees as immutable, creating new instances rather than modifying in place</p></li>
<li><p><strong>Method Support</strong>: Custom PyTree classes can include methods for operations on your data</p></li>
<li><p><strong>Performance</strong>: PyTree flattening/unflattening does reshaping at the tracing stage, meaning that it has minimal runtime overhead compared to typical numerical operations</p></li>
<li><p><strong>Type Support</strong>: PyTrees work with both NumPy arrays and Archimedes symbolic arrays</p></li>
</ul>
<p>For more advanced PyTree operations, explore the <code class="docutils literal notranslate"><span class="pre">archimedes.tree</span></code> module.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="generated/notebooks/control-flow.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Structured Control Flow</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="under-the-hood.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Under the Hood</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Pine Tree Labs, LLC
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Working with PyTrees</a><ul>
<li><a class="reference internal" href="#what-is-a-pytree">What is a PyTree?</a></li>
<li><a class="reference internal" href="#flattening-and-unflattening">Flattening and Unflattening</a></li>
<li><a class="reference internal" href="#custom-pytree-types">Custom PyTree Types</a><ul>
<li><a class="reference internal" href="#custom-nodes-advanced-usage">Custom nodes: advanced usage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-pendulum-simulation-using-pytrees">Example: Pendulum Simulation Using PyTrees</a></li>
<li><a class="reference internal" href="#current-limitations">Current Limitations</a></li>
<li><a class="reference internal" href="#best-practices-and-tips">Best Practices and Tips</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>