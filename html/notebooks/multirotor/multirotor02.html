<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="author" title="About these documents" href="../../about.html" /><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="Part 3: Running the model" href="../../generated/notebooks/multirotor/multirotor03.html" /><link rel="prev" title="Part 1: Fundamentals of multirotor dynamics" href="multirotor01.html" />

    <link rel="shortcut icon" href="../../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>Part 2: Implementation in Archimedes - Archimedes documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=c2950814" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #D35400;
  --color-brand-content: #C0392B;
  --color-admonition-background: rgba(211, 84, 0, 0.1);
  --color-background-primary: #F5F5F5;
  --color-background-secondary: #EEEEEE;
  --color-foreground-primary: #2A2A2A;
  --color-foreground-secondary: #5D4037;
  --color-link: #C0392B;
  --color-link-hover: #D35400;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #F1C40F;
  --color-brand-content: #D35400;
  --color-admonition-background: rgba(241, 196, 15, 0.1);
  --color-background-primary: #2A2A2A;
  --color-background-secondary: #1A1A1A;
  --color-foreground-primary: #F5F5F5;
  --color-foreground-secondary: #DDDDDD;
  --color-link: #D35400;
  --color-link-hover: #F1C40F;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #F1C40F;
  --color-brand-content: #D35400;
  --color-admonition-background: rgba(241, 196, 15, 0.1);
  --color-background-primary: #2A2A2A;
  --color-background-secondary: #1A1A1A;
  --color-foreground-primary: #F5F5F5;
  --color-foreground-secondary: #DDDDDD;
  --color-link: #D35400;
  --color-link-hover: #F1C40F;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Archimedes  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
    <div class="sidebar-brand-container">
      <img class="sidebar-logo" src="../../_static/logo.png" alt="Logo"/>
      <div class="sidebar-brand-text">Archimedes</div>
    </div>
  </a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">What is Archimedes?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting Started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../under-the-hood.html">Under the Hood</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pytrees.html">Working with PyTrees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/notebooks/control-flow.html">Structured Control Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/notebooks/modular-design.html">Hierarchical Design Patterns</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="multirotor00.html">Multirotor Dynamics</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Multirotor Dynamics</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="multirotor01.html">Part 1: Fundamentals of multirotor dynamics</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Part 2: Implementation in Archimedes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/notebooks/multirotor/multirotor03.html">Part 3: Running the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/notebooks/multirotor/multirotor04.html">Part 4: Model analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/notebooks/multirotor/multirotor05.html">Part 5: Revisiting the rotor model (optional)</a></li>
<li class="toctree-l2"><a class="reference internal" href="multirotor06.html">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../deployment/deployment00.html">Deploying to Hardware</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Deploying to Hardware</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../generated/notebooks/deployment/deployment01.html">Generating C code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/notebooks/deployment/deployment02.html">Generating driver code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/notebooks/deployment/deployment03.html">Platform-specific deployment templates</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gotchas.html">🔪 Quirks and Gotchas</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../reference/index.html">📚 API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of 📚 API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.codegen.html">archimedes.codegen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.array.html">archimedes.array</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.sym.html">archimedes.sym</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.sym_like.html">archimedes.sym_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.zeros.html">archimedes.zeros</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.ones.html">archimedes.ones</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.zeros_like.html">archimedes.zeros_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.ones_like.html">archimedes.ones_like</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.eye.html">archimedes.eye</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.scan.html">archimedes.scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.switch.html">archimedes.switch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.vmap.html">archimedes.vmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.compile.html">archimedes.compile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.callback.html">archimedes.callback</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.grad.html">archimedes.grad</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.jac.html">archimedes.jac</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.hess.html">archimedes.hess</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.jvp.html">archimedes.jvp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.vjp.html">archimedes.vjp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.interpolant.html">archimedes.interpolant</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.integrator.html">archimedes.integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.odeint.html">archimedes.odeint</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.nlp_solver.html">archimedes.nlp_solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.minimize.html">archimedes.minimize</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.implicit.html">archimedes.implicit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.root.html">archimedes.root</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/api/archimedes.qpsol.html">archimedes.qpsol</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../generated/api/archimedes.tree.html">archimedes.tree</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of archimedes.tree</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.all.html">archimedes.tree.all</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.flatten.html">archimedes.tree.flatten</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.leaves.html">archimedes.tree.leaves</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.map.html">archimedes.tree.map</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.ravel.html">archimedes.tree.ravel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.reduce.html">archimedes.tree.reduce</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.register_dataclass.html">archimedes.tree.register_dataclass</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.register_pytree_node.html">archimedes.tree.register_pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.structure.html">archimedes.tree.structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.unflatten.html">archimedes.tree.unflatten</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../generated/api/archimedes.tree.struct.html">archimedes.tree.struct</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of archimedes.tree.struct</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.struct.dataclass_transform.html">archimedes.tree.struct.dataclass_transform</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.struct.field.html">archimedes.tree.struct.field</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.struct.fields.html">archimedes.tree.struct.fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.struct.is_pytree_node.html">archimedes.tree.struct.is_pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.struct.pytree_node.html">archimedes.tree.struct.pytree_node</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.struct.register_dataclass.html">archimedes.tree.struct.register_dataclass</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.struct.replace.html">archimedes.tree.struct.replace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.struct.Any.html">archimedes.tree.struct.Any</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.struct.Callable.html">archimedes.tree.struct.Callable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.struct.InitVar.html">archimedes.tree.struct.InitVar</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/api/archimedes.tree.struct.TypeVar.html">archimedes.tree.struct.TypeVar</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Development Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../licensing-model.html">Licensing model</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../../_sources/notebooks/multirotor/multirotor02.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="part-2-implementation-in-archimedes">
<h1>Part 2: Implementation in Archimedes<a class="headerlink" href="#part-2-implementation-in-archimedes" title="Link to this heading">¶</a></h1>
<p>Now that we have a set of equations defining our basic multirotor vehicle model, we can start thinking about implementation.
The basic task here is to construct a function <span class="math notranslate nohighlight">\(\dot{\mathbf{x}} = \mathbf{f}(t, \mathbf{x}, \mathbf{u})\)</span> that we can use to simulate the model, where <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> is the 12-element state vector defined above and <span class="math notranslate nohighlight">\(\mathbf{u}\)</span> is the <span class="math notranslate nohighlight">\(N_r\)</span>-element vector of rotor angular velocities (e.g. <span class="math notranslate nohighlight">\(N_r = 4\)</span> for a quadcopter).
Without loss of generality, we can require that the inputs <span class="math notranslate nohighlight">\(\mathbf{u}\)</span> be defined as a function of time and state, so that the system can be expressed in the self-contained form <span class="math notranslate nohighlight">\(\dot{\mathbf{x}} = \mathbf{f}(t, \mathbf{x})\)</span>.</p>
<p>As a side note, for the sake of simplicity we are assuming that the angular velocities are directly given as inputs.
A more complete model might also include motor dynamics, etc. and include more than 12 elements in the state vector.
The state vector can also have additional elements related to the aerodynamics model, representing for instance the locations of point vortices or other reduced representations of the flow field.
These can be represented in the same <span class="math notranslate nohighlight">\(\dot{\mathbf{x}} = \mathbf{f}(t, \mathbf{x})\)</span> form by augmenting the state vector and dynamics function appropriately.</p>
<p>The most basic approach to constructing such a model is to write a function with this signature that implements the entire model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Monolithic model implementation</span>
<span class="sd">    </span>
<span class="sd">    Assumes separate functions `dcm`, `u`, `net_forces`, and `euler_kinematics`&quot;&quot;&quot;</span>
    <span class="n">p_N</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># Position of the center of mass in the Newtonian frame N (unused here)</span>
    <span class="n">rpy</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>  <span class="c1"># Roll-pitch-yaw Euler angles</span>
    <span class="n">v_B</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>  <span class="c1"># Velocity of the center of mass in body frame B</span>
    <span class="n">w_B</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span> <span class="c1"># Roll-pitch-yaw rates in body frame (ω_B)</span>

    <span class="c1"># Convert roll-pitch-yaw (rpy) orientation to the direction cosine matrix.</span>
    <span class="n">C_BN</span> <span class="o">=</span> <span class="n">dcm</span><span class="p">(</span><span class="n">rpy</span><span class="p">)</span>

    <span class="n">F_B</span><span class="p">,</span> <span class="n">M_B</span> <span class="o">=</span> <span class="n">net_forces</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">C_BN</span><span class="p">)</span>

    <span class="c1"># Transform roll-pitch-yaw rates in the body frame to time derivatives of Euler angles</span>
    <span class="c1"># These are the Euler kinematic equations (1.4-5)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">euler_kinematics</span><span class="p">(</span><span class="n">rpy</span><span class="p">)</span>

    <span class="c1"># Time derivatives of roll-pitch-yaw (rpy) orientation</span>
    <span class="n">drpy</span> <span class="o">=</span> <span class="n">H</span> <span class="o">@</span> <span class="n">w_B</span>

    <span class="c1"># Velocity in the Newtonian frame</span>
    <span class="n">dp_N</span> <span class="o">=</span> <span class="n">C_BN</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">v_B</span>

    <span class="c1"># Acceleration in body frame</span>
    <span class="n">dv_B</span> <span class="o">=</span> <span class="p">(</span><span class="n">F_B</span> <span class="o">/</span> <span class="n">m</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">w_B</span><span class="p">,</span> <span class="n">v_B</span><span class="p">)</span>

    <span class="c1"># Angular acceleration in body frame</span>
    <span class="c1"># solve Euler dynamics equation 𝛕 = I α + ω × (I ω)  for α</span>
    <span class="n">dw_B</span> <span class="o">=</span> <span class="n">J_B_inv</span> <span class="o">@</span> <span class="p">(</span><span class="n">M_B</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">w_B</span><span class="p">,</span> <span class="n">J_B</span> <span class="o">@</span> <span class="n">w_B</span><span class="p">))</span>

    <span class="c1"># Pack the state derivatives</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">dp_N</span><span class="p">,</span> <span class="n">drpy</span><span class="p">,</span> <span class="n">dv_B</span><span class="p">,</span> <span class="n">dw_B</span><span class="p">,</span> <span class="n">aux_state_derivs</span><span class="p">])</span>
</pre></div>
</div>
<p>In Archimedes, this implementation can use standard NumPy functions, which are then “traced” symbolically to construct the CasADi computational graph.
This way, it is easy to switch back and forth between vanilla NumPy for development and debugging and Archimedes/CasADi for performance, automatic differentiation, or C code generation.</p>
<p>Although this implementation is straightforward, it is fairly limiting in that changing the models for gravity, vehicle aerodynamics, rotor aerodynamics, etc. requires rewriting the function.
Here we will pursue an alternative design using Python classes to construct a modular and composable modeling framework.
In short, we will create a set of callable classes that implement well-defined interfaces; then we can construct customized dynamics models by treating these as swappable components.</p>
<section id="composable-functors">
<h2>Composable functors<a class="headerlink" href="#composable-functors" title="Link to this heading">¶</a></h2>
<p>In the lingo of object-oriented programming, a “functor” is an object that can be called like a function.
In Python this can be accomplished by implementing the <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method for a class, which allows it to be called with function syntax.
Combining this with the <a class="reference internal" href="../../generated/api/archimedes.tree.struct.pytree_node.html#archimedes.tree.struct.pytree_node" title="archimedes.tree.struct.pytree_node"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">pytree_node</span></code></span></a> concept gives us a simple and powerful pattern for organizing our parameters and functional behavior.
For instance, we can rewrite the 6-dof dynamics function above as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="kn">import</span> <span class="n">struct</span>

<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FlightVehicle</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Callable dataclass implementation&quot;&quot;&quot;</span>
    <span class="n">m</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Vehicle mass</span>
    <span class="n">J_B</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># Vehicle inertia matrix in body-frame coordinates</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;6-dof dynamics implementation</span>
<span class="sd">        </span>
<span class="sd">        Still assumes separate functions `dcm`, `u`, `net_forces`, and `euler_kinematics`&quot;&quot;&quot;</span>
        <span class="c1"># Same as above, except now we can use `self.m`, `self.J_B`, etc</span>
</pre></div>
</div>
<p>While we will use this callable pattern for other components in our model, for consistency with <a class="reference internal" href="../../generated/notebooks/modular-design.html"><span class="doc std std-doc">recommended design patterns in Archimedes</span></a>, we will actually use the name <code class="docutils literal notranslate"><span class="pre">dynamics</span></code> to implement the ODE right-hand side calculation.</p>
<p>At first, it doesn’t look like we’ve gained much with this approach.
Along with external utility functions <code class="docutils literal notranslate"><span class="pre">dcm</span></code> and <code class="docutils literal notranslate"><span class="pre">euler_kinematics</span></code>, we still rely on separately defined functions to compute the inputs and net forces.
We could amend the class definition by making <code class="docutils literal notranslate"><span class="pre">net_forces</span></code> a method of this class.
Since the 6-dof dynamics are generic, but the multirotor forces are much more specific to this particular flight vehicle, it makes sense to define this method as <em>abstract</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="kn">import</span> <span class="n">struct</span>

<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FlightVehicle</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Callable dataclass implementation&quot;&quot;&quot;</span>
    <span class="n">m</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Vehicle mass</span>
    <span class="n">J_B</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># Vehicle inertia matrix in body-frame coordinates</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">C_BN</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Net forces and moments in body frame B&quot;&quot;&quot;</span>
        <span class="c1"># Empty for abstract base class</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;6-dof dynamics implementation&quot;&quot;&quot;</span>
        <span class="c1"># ...</span>
</pre></div>
</div>
<p>This will throw an error if we try to instantiate a <code class="docutils literal notranslate"><span class="pre">FlightVehicle</span></code> as is, since we haven’t implemented the <code class="docutils literal notranslate"><span class="pre">net_forces</span></code> method.
We still have to specialize this to the multirotor by summing contributions from gravity, drag, and each of the rotors:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MultiRotorVehicle</span><span class="p">(</span><span class="n">FlightVehicle</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">net_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">C_BN</span><span class="p">):</span>
        <span class="c1"># Sum forces due to gravity, body aerodynamics, and rotors</span>
        <span class="c1"># ...</span>
</pre></div>
</div>
<p>If we wanted to, we could add a second class for a fixed-wing vehicle that replaced the rotor models with engines, added flight control surfaces, and so on.
We could also add a third class for a satellite that implemented appropriate reference frame transformations, thruster models, etc.
Each of these would reuse the generic part of the code that deals with 6-dof kinematics, implemented in the base class <code class="docutils literal notranslate"><span class="pre">FlightVehicle</span></code>.
This approach is <em>inheritance</em>.</p>
<p>However, this still leaves us with a problem.
We have several different pieces of our model that might independently be swapped out.
For instance, we could independently vary the models for gravity, vehicle aerodynamics, and rotor aerodynamics.
Each combination of these would require a new implementation of <code class="docutils literal notranslate"><span class="pre">net_forces</span></code>, leading to a combinatorial explosion of <code class="docutils literal notranslate"><span class="pre">MultiRotorVehicle</span></code> subclasses.</p>
<p>This is where <em>composition</em> comes in.
For each of these component models (gravity, vehicle aerodynamics, rotor aerodynamics) we will define an abstract interface and a limited set of concrete implementations.</p>
</section>
<section id="modular-models">
<h2>Modular models<a class="headerlink" href="#modular-models" title="Link to this heading">¶</a></h2>
<p>As a tangible example, let’s say we want to explore the effect of switching between a uniform gravity model <span class="math notranslate nohighlight">\(F_N^g = m g_0 \hat{\mathbf{z}}_N\)</span> and an <span class="math notranslate nohighlight">\(r^{-2}\)</span> point-mass gravity model that depends on the position relative to the Earth’s center of mass.</p>
<p>In the general case the acceleration due to gravity depends on the position of the body in the inertial frame N, although not its velocity or orientation.
With that in mind, we can define a generic callable interface for gravity, with specific implementations for each of our models:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GravityModel</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_N</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gravitational acceleration at the body CM in the inertial frame N</span>

<span class="sd">        Args:</span>
<span class="sd">            p_N: position vector in inertial frame N</span>

<span class="sd">        Returns:</span>
<span class="sd">            g_N: gravitational acceleration in inertial frame N</span>
<span class="sd">        &quot;&quot;&quot;</span>


<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ConstantGravity</span><span class="p">(</span><span class="n">GravityModel</span><span class="p">):</span>
    <span class="n">g0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">9.81</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_N</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g0</span><span class="p">],</span> <span class="n">like</span><span class="o">=</span><span class="n">p_N</span><span class="p">)</span>


<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PointGravity</span><span class="p">(</span><span class="n">GravityModel</span><span class="p">):</span>
    <span class="n">r_EN</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># Position vector from Earth&#39;s CM to the origin of the N frame [m]</span>
    <span class="n">G</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">6.6743e-11</span>  <span class="c1"># Gravitational constant [N-m²/kg²]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_N</span><span class="p">):</span>
        <span class="c1"># ...</span>
</pre></div>
</div>
<p>We could also include an oblate-Earth model, lookup tables based on measured gravity, etc.</p>
<p>With this clearly-defined interface, we can add a gravity model to the <code class="docutils literal notranslate"><span class="pre">MultiRotorVehicle</span></code> and reliably access it as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MultiRotorVehicle</span><span class="p">(</span><span class="n">FlightVehicle</span><span class="p">):</span>
    <span class="n">gravity_model</span><span class="p">:</span> <span class="n">GravityModel</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">net_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">C_BN</span><span class="p">):</span>
        <span class="c1"># Sum forces due to gravity, body aerodynamics, and rotors</span>
        <span class="n">p_N</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># Location of body CM in N-frame coordinates</span>
        <span class="n">Fgravity_N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gravity_model</span><span class="p">(</span><span class="n">p_N</span><span class="p">)</span>
        <span class="c1"># ...</span>
</pre></div>
</div>
<p>Now we can customize our gravity model outside of the vehicle dynamics, allowing us to swap models without modifying the code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">g0</span> <span class="o">=</span> <span class="mf">9.81</span>
<span class="n">m</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">J_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">])</span>
<span class="n">gravity</span> <span class="o">=</span> <span class="n">ConstantGravity</span><span class="p">(</span><span class="n">g0</span><span class="o">=</span><span class="n">g0</span><span class="p">)</span>
<span class="n">vehicle</span> <span class="o">=</span> <span class="n">MultiRotorVehicle</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">J_B</span><span class="o">=</span><span class="n">J_B</span><span class="p">,</span> <span class="n">gravity_model</span><span class="o">=</span><span class="n">gravity</span><span class="p">)</span>
</pre></div>
</div>
<p>For our purposes, a constant gravity model will likely not be the limiting factor on the model accuracy, but it illustrates the basic idea.
In the implementation used below, we ultimately have three abstract model interfaces: <code class="docutils literal notranslate"><span class="pre">RotorModel</span></code>, <code class="docutils literal notranslate"><span class="pre">VehicleDragModel</span></code>, and <code class="docutils literal notranslate"><span class="pre">GravityModel</span></code>.
The <code class="docutils literal notranslate"><span class="pre">VehicleDragModel</span></code> simply computes drag forces and moments, while the <code class="docutils literal notranslate"><span class="pre">RotorModel</span></code> is responsible for computing forces and moments due to a single rotor.
The rotor model is called repeatedly for each of the rotors.
This requires knowing the position and orientation of the rotor disk with respect to the body center of mass, for which we introduce a “hub frame” <span class="math notranslate nohighlight">\(H_j\)</span> for each of the <span class="math notranslate nohighlight">\(N_r\)</span> rotors.
To help manage this we also introduce a fourth “pure” dataclass, <code class="docutils literal notranslate"><span class="pre">RotorGeometry</span></code>.
All told, our basic class structure looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">archimedes</span><span class="w"> </span><span class="kn">import</span> <span class="n">struct</span>


<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FlightVehicle</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Callable dataclass implementation&quot;&quot;&quot;</span>
    <span class="n">m</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Vehicle mass</span>
    <span class="n">J_B</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># Vehicle inertia matrix in body-frame coordinates</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">C_BN</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Net forces and moments in body frame B&quot;&quot;&quot;</span>
        <span class="c1"># Empty for abstract base class</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;6-dof dynamics implementation&quot;&quot;&quot;</span>
        <span class="c1"># ...</span>


<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RotorGeometry</span><span class="p">:</span>
    <span class="n">offset</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  <span class="c1"># Location of the rotor hub in the body frame B [m]</span>
    <span class="n">ccw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># True if rotor spins counter-clockwise when viewed from above</span>
    <span class="n">torsional_cant</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># torsional cant angle χ [rad]</span>
    <span class="n">flapwise_cant</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># flapwise cant angle γ [rad]</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">R_BH</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rotation matrix from the hub frame H to the body frame B&quot;&quot;&quot;</span>
        <span class="c1"># ...</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">r_B</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Offset of the rotor hub in the body frame coordinates B&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># To use this as a &quot;static arg&quot; in Archimedes it has to be hashable</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsional_cant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flapwise_cant</span><span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">VehicleDragModel</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drag forces and moments in body frame B</span>

<span class="sd">        Args:</span>
<span class="sd">            t: time</span>
<span class="sd">            x: state vector</span>

<span class="sd">        Returns:</span>
<span class="sd">            F_B: drag forces in body frame B</span>
<span class="sd">            M_B: drag moments in body frame B</span>
<span class="sd">        &quot;&quot;&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">GravityModel</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_N</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gravitational acceleration at the body CM in the inertial frame N</span>

<span class="sd">        Args:</span>
<span class="sd">            p_N: position vector in inertial frame N</span>

<span class="sd">        Returns:</span>
<span class="sd">            g_N: gravitational acceleration in inertial frame N</span>
<span class="sd">        &quot;&quot;&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RotorModel</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v_B</span><span class="p">,</span> <span class="n">w_B</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">RotorGeometry</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aerodynamic forces and moments in body frame B</span>

<span class="sd">        Args:</span>
<span class="sd">            t: time</span>
<span class="sd">            v_B: velocity of the center of mass in body frame B</span>
<span class="sd">            w_B: angular velocity in body frame B</span>
<span class="sd">            x: state vector</span>
<span class="sd">            u: rotor speed</span>
<span class="sd">            geometry: rotor geometry</span>

<span class="sd">        Returns:</span>
<span class="sd">            F_B: aerodynamic forces for this rotor in body frame B</span>
<span class="sd">            M_B: aerodynamic moments for this rotor in body frame B</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Call self.wind_frame_loads to get F_W and M_W</span>
        <span class="c1"># Then translate to hub frame H (defined by `geometry`)</span>
        <span class="c1"># and finally return body frame </span>
        <span class="c1"># ...</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">wind_frame_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v_W</span><span class="p">,</span> <span class="n">w_W</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">geometry</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aerodynamic forces and moments in wind frame W&quot;&quot;&quot;</span>


<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MultiRotorVehicle</span><span class="p">(</span><span class="n">FlightVehicle</span><span class="p">):</span>
    <span class="n">rotors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RotorGeometry</span><span class="p">]</span>
    <span class="n">rotor_model</span><span class="p">:</span> <span class="n">RotorModel</span>
    <span class="n">drag_model</span><span class="p">:</span> <span class="n">VehicleDragModel</span>
    <span class="n">gravity_model</span><span class="p">:</span> <span class="n">GravityModel</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">net_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">C_BN</span><span class="p">):</span>
        <span class="c1"># Sum forces due to gravity, body aerodynamics, and rotors</span>
        <span class="c1"># ...</span>
</pre></div>
</div>
<p>See the source code for the specific implementations of the code snipped with ellipses comments.
For the basic dynamics model described above, we will also have concrete implementations of <code class="docutils literal notranslate"><span class="pre">VehicleDragModel</span></code>, <code class="docutils literal notranslate"><span class="pre">GravityModel</span></code>, and <code class="docutils literal notranslate"><span class="pre">RotorModel</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">QuadraticDragModel</span><span class="p">(</span><span class="n">VehicleDragModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple velocity-squared drag model for the main vehicle body&quot;&quot;&quot;</span>
    <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.225</span>  <span class="c1"># air density [kg/m^3]</span>
    <span class="n">Cd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># drag coefficient</span>
    <span class="n">A</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># reference planform area [m^2]</span>
    <span class="n">r_CoP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Center of pressure offset from body CG [m]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">v_B</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>  <span class="c1"># Velocity of the center of mass in body frame B</span>

        <span class="c1"># Velocity magnitude with guard against near-zero values</span>
        <span class="n">v_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_B</span><span class="p">)</span>
        <span class="n">v_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v_mag</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">v_mag</span><span class="p">)</span>

        <span class="c1"># Drag force in body frame (3-element vector)</span>
        <span class="n">D_B</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cd</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">*</span> <span class="n">v_mag</span> <span class="o">*</span> <span class="n">v_B</span>

        <span class="c1"># Drag moment in body frame (3-element vector)</span>
        <span class="n">M_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r_CoP</span><span class="p">,</span> <span class="n">D_B</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">D_B</span><span class="p">,</span> <span class="n">M_B</span>


<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ConstantGravity</span><span class="p">(</span><span class="n">GravityModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Uniform gravitational field (flat-Earth approximation)&quot;&quot;&quot;</span>
    <span class="n">g0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">9.81</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_N</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g0</span><span class="p">],</span> <span class="n">like</span><span class="o">=</span><span class="n">p_N</span><span class="p">)</span>


<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">QuadraticRotorModel</span><span class="p">(</span><span class="n">RotorModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Velocity-squared model for rotor aerodynamics&quot;&quot;&quot;</span>
    <span class="n">kF</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># aerodynamic force constant [N/rad^2]</span>
    <span class="n">kM</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0245</span>  <span class="c1"># aerodynamic torque constant [N*m/rad^2]</span>

    <span class="n">num_states</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">wind_frame_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v_W</span><span class="p">,</span> <span class="n">w_W</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">RotorGeometry</span><span class="p">):</span>
        <span class="n">M_sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">ccw</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">z_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
        <span class="n">u_sq</span> <span class="o">=</span> <span class="n">u</span> <span class="o">*</span> <span class="n">u</span>

        <span class="c1"># Note that the wind and hub frame z-axes are coincident</span>
        <span class="n">F_W</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">kF</span> <span class="o">*</span> <span class="n">u_sq</span> <span class="o">*</span> <span class="n">z_W</span>
        <span class="n">M_W</span> <span class="o">=</span> <span class="n">M_sign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kM</span> <span class="o">*</span> <span class="n">u_sq</span> <span class="o">*</span> <span class="n">z_W</span>

        <span class="k">return</span> <span class="n">F_W</span><span class="p">,</span> <span class="n">M_W</span>
</pre></div>
</div>
<p>The full class hierarchy so far is summarized graphically below:</p>
<img alt="../../_images/class_hierarchy.png" class="only-light" src="../../_images/class_hierarchy.png" />
<img alt="../../_images/class_hierarchy_dark.png" class="only-dark" src="../../_images/class_hierarchy_dark.png" />
<p>While we don’t expect to need any other gravity models in this case, it is certainly possible that replacing the vehicle drag model with one that accounts for angle of attack and sideslip angle would improve the accuracy of the model.
In this tutorial, however, we will primarily focus on improving the rotor model; the additional model components are included to illustrate the approach to constructing a modeling framework by using the programming principles of abstraction, inheritance, and composition.</p>
</section>
<section id="composition-vs-inheritance">
<h2>Composition vs. Inheritance<a class="headerlink" href="#composition-vs-inheritance" title="Link to this heading">¶</a></h2>
<p>We now have a flexible, modular, and extensible framework for 6-dof vehicle dynamics modeling.
In essence, we have defined a set of “building blocks” from which we construct our main dynamics model <span class="math notranslate nohighlight">\(\dot{\mathbf{x}} = \mathbf{f}(t, \mathbf{x}, \mathbf{u})\)</span> (in code: <code class="docutils literal notranslate"><span class="pre">FlightVehicle.dynamics(t,</span> <span class="pre">x,</span> <span class="pre">u)</span></code>).
We have used two principal concepts to design this framework: composition (a primary class that “owns” several components with well-defined interfaces) and inheritance (a base class and subclasses).
A key question is: when do you prefer composition and when do you choose inheritance?</p>
<p>A commonly quoted design pattern is to “prefer composition over inheritance” based on the idea that inheritance will lead to the combinatorial explosion of subclasses: <code class="docutils literal notranslate"><span class="pre">MultiRotorWithConstantGravityAndQuadraticDrag</span></code>, <code class="docutils literal notranslate"><span class="pre">MultiRotorWithPointMassGravityAndTabulatedDrag</span></code>, etc.</p>
<p>A more precise rule of thumb is to ask whether the base class “X is a Y” or “X has a Y”.
The right solution is typically inheritance in the former case and composition in the latter.
In our case, it’s easy to plug in the class names to understand the hierarchy:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MultiRotorVehicle</span></code> <em>is</em> a <code class="docutils literal notranslate"><span class="pre">FlightVehicle</span></code> (inheritance)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MultiRotorVehicle</span></code> <em>has</em> a <code class="docutils literal notranslate"><span class="pre">GravityModel</span></code> (composition)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ConstantGravity</span></code> <em>is</em> a <code class="docutils literal notranslate"><span class="pre">GravityModel</span></code> (inheritance)</p></li>
</ul>
<p>It’s worth taking a minute to make sense of the class structure here, since we’ll expand it significantly with the blade element momentum theory aerodynamics model (a new <code class="docutils literal notranslate"><span class="pre">RotorModel</span></code> implementation) later in this tutorial.</p>
<p>This is far from the only (or probably even the best way) to construct this kind of modeling framework, but for more complicated models it’s almost certainly preferable to the “monolithic” approach we started with.</p>
</section>
<section id="using-archimedes">
<h2>Using Archimedes<a class="headerlink" href="#using-archimedes" title="Link to this heading">¶</a></h2>
<p>You may have noticed that none of our model implementations so far use Archimedes beyond using the <a class="reference internal" href="../../generated/api/archimedes.tree.struct.pytree_node.html#archimedes.tree.struct.pytree_node" title="archimedes.tree.struct.pytree_node"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">pytree_node</span></code></span></a> decorator to create composable models.
Still, because we have only used NumPy functions (and have been careful to include <code class="docutils literal notranslate"><span class="pre">like=x</span></code> whenever we call <code class="docutils literal notranslate"><span class="pre">np.array</span></code>), we can evaluate any of these methods symbolically just as easily as we can with numerical arrays.
As we’ll see, this makes it easy to develop a model in pure NumPy and then use Archimedes for advanced use cases like accelerated simulation, optimization, stability analysis, and C code generation.</p>
<p>In terms of design, the key thing to remember is to create <em>pure</em> functions (or methods).
A pure function does not modify <em>anything</em>, including its inputs; it just computes the output as a function of the inputs.
In general, if you start by writing the mathematical equations and then implementing them as close to the math as possible, the resulting functions will tend to be pure (if for no other reason, since it’s just not easy to write “impure math” on paper).</p>
<p>Specifically, we don’t want to use preallocated “work” variables to store intermediate results:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PureCallable</span><span class="p">:</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># OK for symbolic evaluation with Archimedes</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="nd">@struct</span><span class="o">.</span><span class="n">pytree_node</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ImpureCallable</span><span class="p">:</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Try to save allocations with pre-allocated variable</span>

    <span class="c1"># Not OK for symbolic evaluation with Archimedes</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>What happens in the latter case is that Archimedes will feed a <a class="reference internal" href="../../generated/api/archimedes.sym.html#archimedes.sym" title="archimedes.sym"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">SymbolicArray</span></code></span></a> object to <code class="docutils literal notranslate"><span class="pre">ImpureCallable.__call__</span></code>, which will then <em>store</em> the <a class="reference internal" href="../../generated/api/archimedes.sym.html#archimedes.sym" title="archimedes.sym"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">SymbolicArray</span></code></span></a> resulting from the sine function in <code class="docutils literal notranslate"><span class="pre">self.y</span></code>.
While this might actually work in this case, you will get stray symbolic objects in unexpected places which can cause all kinds of unexpected problems.
Basically, behavior for impure functions and callable classes is not well-defined and these should be avoided at all costs.
In fact, by default the <code class="docutils literal notranslate"><span class="pre">pytree_node</span></code> decorator will create a “frozen” class definition, meaning that it will throw an error if you even try to modify one of the object’s fields.
This can be overridden, but it’s done as a reminder to write pure functions.</p>
<p>This <em>does</em> mean that the most efficient NumPy code you can write will likely look different from code that is compatible with Archimedes, since fast NumPy code will usually use pre-allocated arrays, as with C or FORTRAN codes.
Don’t worry, though - the CasADi symbolic system is very efficient and good at figuring this kind of thing out.
As a result, code that looks suboptimal in pure Python can still be very efficient in Archimedes</p>
<p>Besides writing pure functions, keep in mind the usual <a class="reference internal" href="../../gotchas.html"><span class="doc std std-doc">gotchas</span></a> related to control flow: basically, avoid <code class="docutils literal notranslate"><span class="pre">while</span></code> loops and <code class="docutils literal notranslate"><span class="pre">if/else</span></code> statements depending on variable data (tip: the latter can often be replaced with <code class="docutils literal notranslate"><span class="pre">np.where</span></code>).</p>
</section>
<section id="built-in-flightvehicle">
<h2>Built-in <code class="docutils literal notranslate"><span class="pre">FlightVehicle</span></code><a class="headerlink" href="#built-in-flightvehicle" title="Link to this heading">¶</a></h2>
<p>Finally, although we have included <code class="docutils literal notranslate"><span class="pre">FlightVehicle</span></code> as part of our class hierarchy here, there is actually a generic <code class="docutils literal notranslate"><span class="pre">FlightVehicle</span></code> included with Archimedes that implements 6dof dynamics using either Euler angles or (by default) quaternions for attitude representation.
The interface is the same as what we’ve shown here, and you can look at the source code in <a class="reference external" href="https://github.com/jcallaham/archimedes/tree/main/docs/source/notebooks/multirotor/multirotor.py">multirotor.py</a> to see how exactly it builds on the generic <code class="docutils literal notranslate"><span class="pre">FlightVehicle</span></code>.</p>
<p>One difference with what we’ve shown here is that instead of using a flat 12-element vector to represent the state of the vehicle, the built-in <code class="docutils literal notranslate"><span class="pre">FlightVehicle</span></code> defines its own <code class="docutils literal notranslate"><span class="pre">State</span></code> class.
This is another <a class="reference internal" href="../../generated/api/archimedes.tree.struct.pytree_node.html#archimedes.tree.struct.pytree_node" title="archimedes.tree.struct.pytree_node"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">pytree_node</span></code></span></a> with fields for each of the four groups of state variables: position (<code class="docutils literal notranslate"><span class="pre">State.p_N</span></code>), attitude (<code class="docutils literal notranslate"><span class="pre">State.att</span></code>), velocity (<code class="docutils literal notranslate"><span class="pre">State.v_B</span></code>), angular velocity (<code class="docutils literal notranslate"><span class="pre">State.w_B</span></code>), and any additional state variables (<code class="docutils literal notranslate"><span class="pre">State.aux</span></code>).
The naming convention follows <a class="reference external" href="https://drake.mit.edu/doxygen_cxx/group__multibody__notation__basics.html">monogram notation</a>.</p>
<p>This avoids the need to remember what index represents the <span class="math notranslate nohighlight">\(y\)</span>-component of angular velocity, for example.
It also makes it easier to switch between attitude representations and allows for arbitrary additional state variables in the <code class="docutils literal notranslate"><span class="pre">aux</span></code> field.
For instance, if we have a rotor model that includes unsteady aerodynamics, these states can be defined as more <a class="reference internal" href="../../generated/api/archimedes.tree.struct.pytree_node.html#archimedes.tree.struct.pytree_node" title="archimedes.tree.struct.pytree_node"><span class="xref myst py py-func"><code class="docutils literal notranslate"><span class="pre">pytree_node</span></code></span></a>s and nested inside the <code class="docutils literal notranslate"><span class="pre">FlightVehicle.State.aux</span></code> field.</p>
<p>For more details on pure functions and PyTrees, see:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../under-the-hood.html"><span class="doc std std-doc">Under the Hood</span></a></p></li>
<li><p><a class="reference internal" href="../../pytrees.html"><span class="doc std std-doc">Working with PyTrees</span></a></p></li>
<li><p><a class="reference internal" href="../../generated/notebooks/modular-design.html"><span class="doc std std-doc">Hierarchical Design Patterns</span></a></p></li>
<li><p><a class="reference internal" href="../../gotchas.html"><span class="doc std std-doc">Quirks and Gotchas</span></a></p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../../generated/notebooks/multirotor/multirotor03.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Part 3: Running the model</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="multirotor01.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Part 1: Fundamentals of multirotor dynamics</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Pine Tree Labs, LLC
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Part 2: Implementation in Archimedes</a><ul>
<li><a class="reference internal" href="#composable-functors">Composable functors</a></li>
<li><a class="reference internal" href="#modular-models">Modular models</a></li>
<li><a class="reference internal" href="#composition-vs-inheritance">Composition vs. Inheritance</a></li>
<li><a class="reference internal" href="#using-archimedes">Using Archimedes</a></li>
<li><a class="reference internal" href="#built-in-flightvehicle">Built-in <code class="docutils literal notranslate"><span class="pre">FlightVehicle</span></code></a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>